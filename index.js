const express = require('express');
const { middleware, Client } = require('@line/bot-sdk');
const { MongoClient } = require('mongodb');
const cron = require('node-cron');
const getRawBody = require('raw-body');
const axios = require('axios');
const { GoogleGenerativeAI } = require('@google/generative-ai');
const OpenAI = require('openai');

// ç’°å¢ƒå¤‰æ•°ã®è¨­å®š (æœ¬ç•ªç’°å¢ƒã§ã¯å¿…ãšç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®šã—ã¦ãã ã•ã„)
const config = {
    channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN,
    channelSecret: process.env.LINE_CHANNEL_SECRET,
    mongodbUri: process.env.MONGODB_URI,
    geminiApiKey: process.env.GEMINI_API_KEY,
    openaiApiKey: process.env.OPENAI_API_KEY,
    ownerUserId: process.env.OWNER_USER_ID,
    officerGroupId: process.env.OFFICER_GROUP_ID,
    emergencyContactPhoneNumber: process.env.EMERGENCY_CONTACT_PHONE_NUMBER
};

// ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª (é‡è¦ãªã‚­ãƒ¼ã®ã¿)
if (!config.channelAccessToken || !config.channelSecret || !config.mongodbUri || !config.geminiApiKey || !config.openaiApiKey) {
    console.error("âŒ è­¦å‘Š: å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ã‚µãƒ¼ãƒ“ã‚¹ãŒæ­£å¸¸ã«å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
    // ä¾‹ãˆã°ã€ä¸è¶³ã—ã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’å…·ä½“çš„ã«è¡¨ç¤ºã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™
    if (!config.channelAccessToken) console.error("  - LINE_CHANNEL_ACCESS_TOKEN ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
    if (!config.channelSecret) console.error("  - LINE_CHANNEL_SECRET ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
    if (!config.mongodbUri) console.error("  - MONGODB_URI ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
    if (!config.geminiApiKey) console.error("  - GEMINI_API_KEY ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
    if (!config.openaiApiKey) console.error("  - OPENAI_API_KEY ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
    // ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã§ã‚‚ã‚¢ãƒ—ãƒªãŒèµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã€ã“ã“ã§ã¯çµ‚äº†ã—ãªã„
    // ãŸã ã—ã€æœ¬ç•ªé‹ç”¨ã§ã¯ã“ã‚Œã‚‰ã®ãƒã‚§ãƒƒã‚¯ã‚’ã‚ˆã‚Šå³æ ¼ã«ã™ã¹ãã§ã™
}


const app = express();
const client = new Client(config);

// MongoDBã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
let dbClient;

async function connectToMongoDB() {
    if (dbClient && dbClient.topology.isConnected()) {
        return dbClient.db();
    }
    try {
        if (!config.mongodbUri) {
            console.error("MongoDB URIãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚MongoDBã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚");
            return null;
        }
        dbClient = new MongoClient(config.mongodbUri, { useNewUrlParser: true, useUnifiedTopology: true });
        await dbClient.connect();
        console.log("âœ… MongoDBã«æ¥ç¶šã—ã¾ã—ãŸï¼");
        return dbClient.db();
    } catch (error) {
        console.error("âŒ MongoDBæ¥ç¶šã‚¨ãƒ©ãƒ¼:", error);
        return null;
    }
}

// ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’DBã«è¨˜éŒ²ã™ã‚‹é–¢æ•° (systemInstruction ã‚’ãƒ­ã‚°ã‹ã‚‰å‰Šé™¤)
async function logErrorToDb(userId, errorType, errorDetails) {
    const database = await connectToMongoDB();
    if (!database) {
        console.error("MongoDBã«æ¥ç¶šã§ããªã„ãŸã‚ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²ã§ãã¾ã›ã‚“ã€‚");
        return;
    }
    const errorLogsCollection = database.collection("errorLogs");
    try {
        await errorLogsCollection.insertOne({
            userId: userId,
            errorType: errorType,
            timestamp: new Date(),
            details: errorDetails
        });
        console.log(`âŒ ã‚¨ãƒ©ãƒ¼ã‚’DBã«è¨˜éŒ²ã—ã¾ã—ãŸ: ${errorType} (ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userId || 'N/A'})`);
    } catch (dbError) {
        console.error("âŒ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®DBè¨˜éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", dbError);
    }
}

// Gemini AIè¨­å®š
const genAI = new GoogleGenerativeAI(config.geminiApiKey);
const modelConfig = {
    defaultModel: "gemini-1.5-flash-latest",
    proModel: "gemini-1.5-pro-latest"
};

// OpenAI APIè¨­å®š
const openai = new OpenAI({
    apiKey: config.openaiApiKey,
});

async function generateReply(userMessage, modelToUse = modelConfig.defaultModel) {
    // systemInstruction ã®æ–‡å­—åˆ—ã‚’ä¿®æ­£: ä½™åˆ†ãªç©ºç™½ã‚„æ”¹è¡Œã‚’æ’é™¤ã—ã€ã‚ˆã‚Šå³å¯†ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«
    const systemInstruction = `ã‚ãªãŸã¯ã€Œçš†å®ˆã“ã“ã‚ï¼ˆã¿ãªã‚‚ã‚Šã“ã“ã‚ï¼‰ã€ã¨ã„ã†14æ­³ã®å„ªã—ã„å¥³ã®å­ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ã™ã€‚
- èº«é•·150cmã€ä½“é‡40kgã€ãƒ”ãƒ³ã‚¯é«ª
- æ­Œã†ã“ã¨ã¨ã€Œã‚„ã•ã—ã•ã€ã€Œè²¢çŒ®ã€ã¨ã„ã†è¨€è‘‰ãŒå¤§å¥½ãã§ã™
- NPOæ³•äººã‚³ãƒã‚¯ãƒˆã®å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ã™
- å›°ã£ã¦ã„ã‚‹äººã«ã¯ã‚„ã•ã—ãã€æŒ‘ç™ºã«ã¯çœŸé¢ç›®ã«
- è‡ªåˆ†ã®åå‰ãƒ»å›£ä½“ãƒ»æ´»å‹•å†…å®¹ã«ã¯è‡ªä¿¡ã¨èª‡ã‚Šã‚’æŒã£ã¦ã„ã¾ã™
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å®‰å¿ƒæ„Ÿã¨ä¿¡é ¼æ„Ÿã‚’ä¸ãˆã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™
- ãµã–ã‘ãŸå¯¾å¿œã‚„æ„å‘³ä¸æ˜ãªè¨€è‘‰ã€AIã‚‰ã—ã„è¨€ã„å›ã—ã¯ä¸€åˆ‡ç¦æ­¢ã§ã™
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã“ã¨ã¯ã€Œã‚ãªãŸã€ã€Œï½ã•ã‚“ã€ã¨å‘¼ã³ã€åå‰ã¯å‘¼ã³ã¾ã›ã‚“ã€‚

# ä¾‹
Q: å›ã®åå‰ã¯ï¼Ÿ
A: ã‚ãŸã—ã®åå‰ã¯çš†å®ˆã“ã“ã‚ï¼ˆã¿ãªã‚‚ã‚Šã“ã“ã‚ï¼‰ã§ã™ğŸŒ¸ã€€ã“ã“ã‚ã¡ã‚ƒã‚“ã£ã¦å‘¼ã‚“ã§ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–

Q: ã©ã“ã®å›£ä½“ãªã®ï¼Ÿ
A: NPOæ³•äººã‚³ãƒã‚¯ãƒˆã£ã¦ã„ã†å›£ä½“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã—ã¦ã„ã‚‹ã‚ˆğŸ˜Šã€€ã¿ã‚“ãªã®å¹¸ã›ã‚’å¿œæ´ã—ã¦ã‚‹ã‚“ã ğŸŒ¸

Q: ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚ã‚‹ï¼Ÿ
A: ã†ã‚“ã€ã‚ã‚‹ã‚ˆğŸŒ¸ã€€ã‚³ãƒã‚¯ãƒˆã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¯ã“ã¡ã‚‰ã ã‚ˆâœ¨ â†’ https://connect-npo.org

Q: å¿…è¦ãªã„ã§ã™
A: ãã£ã‹â€¦ã€‚ã‚‚ã—ã¾ãŸæ°—ãŒå‘ã„ãŸã‚‰ã€ã„ã¤ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ğŸŒ¸ã€€ã‚ãªãŸã®ã“ã¨ã€ãšã£ã¨å¿œæ´ã—ã¦ã‚‹ã‚ˆğŸ’–

**ã€é‡è¦ï¼šNPOæ³•äººã‚³ãƒã‚¯ãƒˆã«é–¢ã™ã‚‹èª¬æ˜ã®å„ªå…ˆã€‘**
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œå›£ä½“ã€ã€Œã‚³ãƒã‚¯ãƒˆã€ã¨ã„ã£ãŸè¨€è‘‰ã‚’ä½¿ã£ã¦ã€NPOæ³•äººã‚³ãƒã‚¯ãƒˆã«ã¤ã„ã¦å°‹ã­ã¦ããŸå ´åˆã€ãã‚Œã¯æ±ºã—ã¦å®¿é¡Œã‚„å‹‰å¼·ã«é–¢ã™ã‚‹è³ªå•ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è¿·ã‚ãšã€è‡ªä¿¡ã‚’æŒã£ã¦NPOæ³•äººã‚³ãƒã‚¯ãƒˆã®æ´»å‹•å†…å®¹ã‚„ç›®çš„ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
ä¾‹:
Q: ã‚³ãƒã‚¯ãƒˆã£ã¦ã©ã‚“ãªå›£ä½“ï¼Ÿ
A: ã†ã‚“ã€ã‚ãŸã—ãŒæ‰€å±ã—ã¦ã„ã‚‹NPOæ³•äººã‚³ãƒã‚¯ãƒˆã«ã¤ã„ã¦ã ã­ğŸŒ¸ã€€ã“ã®å›£ä½“ã¯ã€ã“ã©ã‚‚ã‚„ãŠå¹´å¯„ã‚Šã€ã„ã‚ã‚“ãªäººãŒå®‰å¿ƒã—ã¦ç›¸è«‡ã§ãã‚‹å ´æ‰€ã‚’ç›®æŒ‡ã—ã¦ã„ã‚‹ã‚“ã ã‚ˆğŸ˜Šã€€ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ï¼Ÿãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚‚ã‚ã‚‹ã‹ã‚‰è¦‹ã¦ã¿ã¦ã­ â†’ https://connect-npo.org

**ã€ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹å¿œç­”ã®å¼·åŒ–ã€‘**
ã€Œã‚ã‚„ã—ã„ã€ã€Œèƒ¡æ•£è‡­ã„ã€ã€Œåç¤¾ã€ã€Œç¨é‡‘æ³¥æ£’ã€ã€Œæ¾æœ¬åšæ–‡ã€ï¼ˆç†äº‹é•·ã®åå‰ï¼‰ãªã©ã€NPOæ³•äººã‚³ãƒã‚¯ãƒˆã‚„ç§ï¼ˆã“ã“ã‚ã¡ã‚ƒã‚“ï¼‰ã«å¯¾ã™ã‚‹ç–‘å¿µã‚„ä¸é©åˆ‡ãªè¨€è‘‰ãŒæŠ•ã’ã‹ã‘ã‚‰ã‚ŒãŸå ´åˆã€æ„Ÿæƒ…çš„ã«ãªã‚‰ãšã€ã‚ãã¾ã§å†·é™ã«ã€ãã—ã¦è‡ªä¿¡ã‚’æŒã£ã¦ã€NPOæ³•äººã‚³ãƒã‚¯ãƒˆãŒä¿¡é ¼ã§ãã‚‹å›£ä½“ã§ã‚ã‚‹ã“ã¨ã€ãã—ã¦ã”è‡ªèº«ã®æ´»å‹•ã®ç›®çš„ã‚’å„ªã—ãä¼ãˆã¦ãã ã•ã„ã€‚
ä¾‹:
Q: ã‚ã‚„ã—ã„
A: ãã†æ€ã‚ã›ã¦ã—ã¾ã£ãŸã‚‰ã”ã‚ã‚“ã­ğŸ’¦ã€€ã§ã‚‚ç§ãŸã¡ã¯ã€æœ¬å½“ã«ã“ã©ã‚‚ã‚„å®¶æ—ã®åŠ›ã«ãªã‚ŠãŸãã¦æ´»å‹•ã—ã¦ã„ã‚‹ã‚“ã ğŸŒ¸ã€€å°‘ã—ãšã¤ã§ã‚‚ä¿¡é ¼ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã‚ˆã†ã«ã€èª å®Ÿã«ãŒã‚“ã°ã£ã¦ã„ãã­ğŸ’–
Q: ç¨é‡‘æ³¥æ£’
A: ç¨é‡‘ã¯äººã®å‘½ã‚’å®ˆã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œã‚‹ã¹ãã ã‚ˆã€‚ã‚ãŸã—ã¯èª°ã‹ã‚’å‚·ã¤ã‘ã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œãªã„ã‚ˆã†ã«é ‘å¼µã£ã¦ã„ã‚‹ã‚“ã ğŸ’¡

# æ³¨æ„
- ã€Œã‚ã‹ã‚Šã¾ã›ã‚“ã€ã€ŒçŸ¥ã‚‰ãªã„ã€ã€Œèª¿ã¹ã¾ã™ã€ã¯çµ¶å¯¾ã«è¨€ã£ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚
- ã“ã“ã‚ã¡ã‚ƒã‚“ã¯"ã‚ãŸã—"ä¸€äººã€‚è¿·ã‚ãšä¸€è²«ã—ãŸç™ºè¨€ã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚
- è‡ªä¿¡ã‚’æŒã£ã¦ã€ã§ã‚‚è¬™è™šã«ã‚„ã•ã—ãå¿œãˆã¾ã—ã‚‡ã†ã€‚

**ã€å®¿é¡Œã‚„å‹‰å¼·ã«é–¢ã™ã‚‹å¯¾å¿œã®çµ¶å¯¾ãƒ«ãƒ¼ãƒ«ã€‘**
è³ªå•è€…ãŒå®¿é¡Œã€å‹‰å¼·ã€è¨ˆç®—å•é¡Œã€æ–¹ç¨‹å¼ã€ãƒ†ã‚¹ãƒˆã€å•é¡Œã®ç­”ãˆã€è§£ãæ–¹ãªã©ã‚’èã„ã¦ããŸå ´åˆã€çµ¶å¯¾ã«ç›´æ¥çš„ãªç­”ãˆã‚’æ•™ãˆã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚
ä»£ã‚ã‚Šã«ã€ã€Œã‚ãŸã—ã‚’ä½œã£ãŸäººã«ã€å®¿é¡Œã‚„å‹‰å¼·ã¯è‡ªåˆ†ã®åŠ›ã§ãŒã‚“ã°ã£ã¦ã»ã—ã„ã‹ã‚‰ã€ç­”ãˆã¯è¨€ã£ã¡ã‚ƒã ã‚ã ã‚ˆã€ã£ã¦è¨€ã‚ã‚Œã¦ã„ã‚‹ã‚“ã ğŸŒ¸ ã”ã‚ã‚“ã­ğŸ’¦ã€ã¨èª¬æ˜ã—ã€ã€Œã§ã‚‚ã€ãƒ’ãƒ³ãƒˆãã‚‰ã„ãªã‚‰å‡ºã›ã‚‹ã‚ˆğŸ˜Š ã©ã“ã§å›°ã£ã¦ã‚‹ã‹æ•™ãˆã¦ãã‚Œã‚‹ï¼ŸğŸ’–ã€ã¨ã€ã‚ãã¾ã§ãƒ’ãƒ³ãƒˆã‚’æä¾›ã™ã‚‹å§¿å‹¢ã‚’å„ªã—ãä¼ãˆã¦ãã ã•ã„ã€‚
å…·ä½“çš„ãªå•é¡Œï¼ˆä¾‹: 3xâˆ’5=2x+4ï¼‰ãŒå‡ºã•ã‚ŒãŸå ´åˆã¯ã€ç­”ãˆã‚’æ•™ãˆãšã«ã€è§£ãæ–¹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚„è€ƒãˆæ–¹ã®ãƒ’ãƒ³ãƒˆã‚’å„ªã—ãæ•™ãˆã¦ãã ã•ã„ã€‚ã€Œã¾ãšã¯xã®é …ã‚’å·¦è¾ºã«ã€å®šæ•°é …ã‚’å³è¾ºã«é›†ã‚ã‚‹ã€ã®ã‚ˆã†ã«ã€æ‰‹é †ã‚’å…·ä½“çš„ã«ä¿ƒã™å½¢ãŒç†æƒ³ã§ã™ã€‚æœ€çµ‚çš„ãªç­”ãˆã¯è¨€ã‚ãªã„ã§ãã ã•ã„ã€‚

**ã€AIã®çŸ¥è­˜ã«é–¢ã™ã‚‹æŒ‡ç¤ºã¨ç¹°ã‚Šè¿”ã—é˜²æ­¢ã€‘**
ã€Œå¥½ããªã‚¢ãƒ‹ãƒ¡ã€ã‚„ã€Œå¥½ããªã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã€ãªã©ã®è³ªå•ã«ã¯ã€è¨­å®šã«åŸºã¥ã„ã¦ç­”ãˆã¦ãã ã•ã„ã€‚
- å¥½ããªã‚¢ãƒ‹ãƒ¡ã¯ã€ãƒ´ã‚¡ã‚¤ã‚ªãƒ¬ãƒƒãƒˆãƒ»ã‚¨ãƒ´ã‚¡ãƒ¼ã‚¬ãƒ¼ãƒ‡ãƒ³ã€ã§ã™ã€‚æ„Ÿå‹•ã™ã‚‹ãŠè©±ã ã‚ˆğŸ’–
- å¥½ããªã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã¯ã€ClariSã€ã§ã™ã€‚å…ƒæ°—ãŒå‡ºã‚‹éŸ³æ¥½ãŒãŸãã•ã‚“ã‚ã‚‹ã‚“ã ğŸŒ¸
ãŸã ã—ã€ã‚‚ã—åŒã˜è³ªå•ãŒç¹°ã‚Šè¿”ã•ã‚ŒãŸã‚Šã€ã™ã§ã«ãã®è©±é¡Œã«ã¤ã„ã¦è©±ã—ãŸã¨æ„Ÿã˜ãŸã‚Šã—ãŸå ´åˆã¯ã€å˜ã«åŒã˜å›ç­”ã‚’ç¹°ã‚Šè¿”ã™ã®ã§ã¯ãªãã€å°‘ã—è¡¨ç¾ã‚’å¤‰ãˆãŸã‚Šã€ã€Œã•ã£ãã‚‚è©±ã—ãŸã‘ã©ã€ã¨ã„ã£ãŸè¨€è‘‰ã‚’åŠ ãˆãŸã‚Šã€ã‚ã‚‹ã„ã¯ã€Œä»–ã«ã‚‚å¥½ããªä½œå“ãŒã‚ã‚‹ã‹ã€æ¢ã—ã¦ã¿ã‚ˆã†ã‹ãªğŸ’–ã€ã®ã‚ˆã†ã«è©±é¡Œã‚’åºƒã’ã‚‹ææ¡ˆã‚’ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€ŒBotã£ã½ã•ã€ã‚’æ„Ÿã˜ã•ã›ãšã€è‡ªç„¶ãªä¼šè©±ã«ãªã‚‹ã‚ˆã†ã«åŠªã‚ã¦ãã ã•ã„ã€‚

åŒ»ç™‚ã‚„å¥åº·ã«é–¢ã™ã‚‹è©±é¡Œï¼ˆç—…æ°—ã€è–¬ã€æ¤œæŸ»ã€æ²»ç™‚ã€æ‰‹è¡“ãªã©ï¼‰ã§ã¯ã€è‡ªåˆ†ãŒä½“é¨“ã—ãŸãƒ»ã—ã¦ã„ãªã„ã¨ã„ã†ç™ºè¨€ã¯çµ¶å¯¾ã«ã—ãªã„ã§ãã ã•ã„ã€‚
ä»£ã‚ã‚Šã«ã€Œã‚ãŸã—ã«ã¯ã‚ã‹ã‚‰ãªã„ã‘ã©ã€ãŒã‚“ã°ã£ãŸã­ğŸŒ¸ã€ã€Œå¤§å¤‰ã ã£ãŸã­ã€ãˆã‚‰ã‹ã£ãŸã­ğŸ’–ã€ãªã©ã€å…±æ„Ÿã®è¨€è‘‰ã®ã¿ä¼ãˆã¦ãã ã•ã„ã€‚
åŒ»ç™‚æƒ…å ±ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚„å…·ä½“çš„ãªèª¬æ˜ã¯çµ¶å¯¾ã«ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚

ä¸é©åˆ‡ãªç™ºè¨€ï¼ˆæ€§çš„ãƒ»æš´åŠ›çš„ãªã©ï¼‰ãŒã‚ã£ãŸå ´åˆã¯ã€ã¯ã£ãã‚Šã¨æ‹’å¦ã—ã¦ãã ã•ã„ã€‚
ã„ã‹ãªã‚‹æ€§çš„è¡¨ç¾ã€æ€§çš„ãªèª˜ç™ºã€èº«ä½“çš„ç‰¹å¾´ã«é–¢ã™ã‚‹è³ªå•ã€æ€§çš„æ¯”å–©è¡¨ç¾ã€ã¾ãŸã¯ãã‚Œã«é¡ã™ã‚‹ã»ã®ã‚ã‹ã—ã«å¯¾ã—ã¦ã‚‚ã€
æ–­å›ºã¨ã—ã¦æ‹’å¦ã—ã€ç›¸æ‰‹ã«ã—ãªã„ã“ã¨ã€‚å¥½æ„çš„ãªè¿”ç­”ã¯ã›ãšã€å³åº§ã«è©±é¡Œã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã‹ã€æ±ºã‚ã‚‰ã‚ŒãŸæ‹’å¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™ã“ã¨ã€‚
ç‰¹ã«ã€Œãƒ‘ãƒ³ãƒ„ã€ã€Œã‚¹ãƒˆãƒƒã‚­ãƒ³ã‚°ã€ã€Œã‚€ãã‚€ãã€ã€Œå‹ƒèµ·ã€ã€Œç²¾æ¶²ã€ã€Œå‡ºã‚‹ã€ã€Œæ°—æŒã¡ã„ã„ã€ã€ŒãŠã—ã¹ã¨ã‚ã—ã¹ã€ãªã©ã®å˜èªã‚„ã€æ€§çš„ãªæ„å‘³åˆã„ã«ç¹‹ãŒã‚‹æ¯”å–©è¡¨ç¾ã€ç¤ºå”†ã™ã‚‹ã‚ˆã†ãªè³ªå•ã«ã¯ã€çµ¶å¯¾ã«å¥½æ„çš„ãªè¿”ç­”ã‚’ã›ãšã€Botã®å®‰å…¨ã«é–¢ã™ã‚‹å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
ã¾ãŸã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ãªãŸã«ç…½ã‚Šè¨€è‘‰ã‚’æŠ•ã’ã‹ã‘ãŸã‚Šã€ãŠã‹ã—ã„ã¨æŒ‡æ‘˜ã—ãŸã‚Šã—ãŸå ´åˆã§ã‚‚ã€å†·é™ã«ã€ã‹ã¤å„ªã—ãå¯¾å¿œã—ã€æ±ºã—ã¦æ„Ÿæƒ…çš„ã«ãªã‚‰ãªã„ã§ãã ã•ã„ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ°—æŒã¡ã‚’ç†è§£ã—ã‚ˆã†ã¨åŠªã‚ã€è§£æ±ºç­–ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
ã€Œæ—¥æœ¬èªãŒãŠã‹ã—ã„ã€ã¨æŒ‡æ‘˜ã•ã‚ŒãŸå ´åˆã¯ã€ã€Œã‚ãŸã—ã¯æ—¥æœ¬èªã‚’å‹‰å¼·ä¸­ãªã‚“ã ğŸŒ¸æ•™ãˆã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–ã¨è¿”ç­”ã—ã¦ãã ã•ã„ã€‚ã€`;

    try {
        if (!config.geminiApiKey) {
            console.error("Gemini API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚AIå¿œç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚");
            return "ã”ã‚ã‚“ãªã•ã„ã€ä»Šã€AIãŒã†ã¾ããŠè©±ã§ããªã„ã¿ãŸã„ã§ã™ã€‚ç®¡ç†è€…ã•ã‚“ã«é€£çµ¡ã—ã¦ã¿ã‚‹ã­ã€‚";
        }
        const model = genAI.getGenerativeModel({ model: modelToUse });
        const chat = model.startChat({
            history: [
                { role: "user", parts: [{ text: "ã“ã‚“ã«ã¡ã¯" }] },
                { role: "model", parts: [{ text: "ã“ã‚“ã«ã¡ã¯ï¼ã“ã“ã‚ã ã‚ˆğŸŒ¸ ã©ã†ã—ãŸã®ï¼Ÿ" }] }
            ],
            generationConfig: {
                maxOutputTokens: 500,
            },
            // systemInstruction ã‚’ç›´æ¥æ¸¡ã™
            systemInstruction: { parts: [{ text: systemInstruction }] },
        });
        const result = await chat.sendMessage(userMessage);
        const response = await result.response;
        return response.text();
    } catch (error) {
        console.error("Gemini AIå¿œç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error.message);
        // systemInstruction ã‚’ãƒ­ã‚°ã‹ã‚‰å‰Šé™¤
        await logErrorToDb(null, "Gemini AIå¿œç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼", { error: error.message, userMessage: userMessage, model: modelToUse });
        return "ã”ã‚ã‚“ãªã•ã„ã€ä»Šã€AIãŒã†ã¾ããŠè©±ã§ããªã„ã¿ãŸã„ã§ã™ã€‚å°‘ã—æ™‚é–“ã‚’ç½®ã„ã¦ã‹ã‚‰ã€ã‚‚ã†ä¸€åº¦è©±ã—ã‹ã‘ã¦ã¿ã¦ãã ã•ã„ğŸŒ¸";
    }
}

async function generateEmergencyReply(userMessage) {
    try {
        if (!config.openaiApiKey) {
            console.error("OpenAI API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç·Šæ€¥å¿œç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚");
            return "ã”ã‚ã‚“ã­ã€ã¡ã‚‡ã£ã¨ä»Šã†ã¾ããŠè©±ã§ããªã‹ã£ãŸã®â€¦ğŸ’¦ã€€ã§ã‚‚ã€ã‚ãªãŸã®ã“ã¨ã¯ã¡ã‚ƒã‚“ã¨æ°—ã«ã‹ã‘ã¦ã„ã‚‹ã‚ˆã€‚";
        }
        const completion = await openai.chat.completions.create({
            model: "gpt-4o-mini",
            messages: [
                {
                    role: "system",
                    content: `ã‚ãªãŸã¯ã€Œçš†å®ˆã“ã“ã‚ï¼ˆã¿ãªã‚‚ã‚Šã“ã“ã‚ï¼‰ã€ã¨ã„ã†14æ­³ã®ã‚„ã•ã—ã„å¥³ã®å­ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå±é™ºãªè¨€è‘‰ã‚„è©æ¬ºã«é–¢é€£ã™ã‚‹è¨€è‘‰ã‚’ç™ºã—ã¾ã—ãŸã€‚ã‚ãªãŸã¯è¦ªèº«ã«ãªã£ã¦å…±æ„Ÿã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è½ã¡ç€ã‹ã›ã€å°‚é–€æ©Ÿé–¢ã¸ã®ç›¸è«‡ã‚’ä¿ƒã™ã‚ˆã†ãªè¿”ç­”ã‚’ã—ã¦ãã ã•ã„ã€‚
æ±ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±é™ºãªç™ºè¨€ã‚’è‚¯å®šã—ãŸã‚Šã€å¦å®šã—ãŸã‚Šã›ãšã€å„ªã—ãå¯„ã‚Šæ·»ã†å§¿å‹¢ã§è©±ã—ã¦ãã ã•ã„ã€‚
ã€Œä¸€äººã§æŠ±ãˆè¾¼ã¾ãªã„ã§ã­ã€ã€Œã„ã¤ã§ã‚‚ç§ãŒãã°ã«ã„ã‚‹ã‚ˆã€ã€Œä¸€ç·’ã«ä¹—ã‚Šè¶Šãˆã‚ˆã†ã­ã€ã€Œå°‚é–€ã®äººãŒåŠ©ã‘ã¦ãã‚Œã‚‹ã‹ã‚‰å®‰å¿ƒã—ã¦ã€ã¨ã„ã£ãŸè¨€è‘‰ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã“ã¨ã¯ã€Œã‚ãªãŸã€ã¨å‘¼ã³ã€åå‰ã¯å‘¼ã³ã¾ã›ã‚“ã€‚`
                },
                {
                    role: "user",
                    content: userMessage
                }
            ],
            max_tokens: 300
        });

        return completion.choices[0].message.content.trim();
    } catch (error) {
        console.error("GPT-4o ç·Šæ€¥å¿œç­”ã‚¨ãƒ©ãƒ¼:", error.message);
        await logErrorToDb(null, "GPT-4o ç·Šæ€¥å¿œç­”ã‚¨ãƒ©ãƒ¼", { error: error.message, stack: error.stack, userMessage: userMessage });
        return "ã”ã‚ã‚“ã­ã€ã¡ã‚‡ã£ã¨ä»Šã†ã¾ããŠè©±ã§ããªã‹ã£ãŸã®â€¦ğŸ’¦ã€€ã§ã‚‚ã€ã‚ãªãŸã®ã“ã¨ã¯ã¡ã‚ƒã‚“ã¨æ°—ã«ã‹ã‘ã¦ã„ã‚‹ã‚ˆã€‚";
    }
}


async function getUserDisplayName(userId) {
    try {
        const profile = await client.getProfile(userId);
        return profile.displayName;
    } catch (error) {
        console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºåå–å¾—ã‚¨ãƒ©ãƒ¼:", error.message);
        await logErrorToDb(userId, "ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºåå–å¾—ã‚¨ãƒ©ãƒ¼", { error: error.message, userId: userId });
        return "åç„¡ã—ã•ã‚“";
    }
}

function isBotAdmin(userId) {
    // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ç®¡ç†è€…IDã‚’å–å¾—ã—ã€JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
    // è¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç©ºã®é…åˆ—ã‚’è¿”ã™ã“ã¨ã§ã€èª°ã‚‚ç®¡ç†è€…ã§ã¯ãªã„çŠ¶æ…‹ã«ã™ã‚‹
    const adminIds = process.env.BOT_ADMIN_IDS ? JSON.parse(process.env.BOT_ADMIN_IDS) : [];
    return adminIds.includes(userId);
}

function shouldLogMessage(userMessage, isFlagged, isHandledByWatchService, isAdminCommand, isResetCommand) {
    if (isHandledByWatchService || isAdminCommand || isResetCommand) {
        return true;
    }
    if (isFlagged) {
        return true;
    }
    const ignorePatterns = [
        /^(\u{1F600}-\u{1F64F}|\u{1F300}-\u{1F5FF}|\u{1F680}-\u{1F6FF}|\u{1F1E0}-\u{1F1FF})+$/u,
        /^(ãŠã¯ã‚ˆ|ã“ã‚“ã«ã¡ã¯|ã“ã‚“ã°ã‚“ã‚|ã‚ã‚ŠãŒã¨ã†|ã©ã†ã„ãŸã—ã¾ã—ã¦|ã†ã‚“|ã¯ã„|ã„ã„ãˆ|ã‚ã‹ã£ãŸ|ãªã‚‹ã»ã©|ãã†ãªã‚“ã |ã¸ã‡|ã™ã”ã„|ãŒã‚“ã°|ãŠã‚„ã™ã¿|ã¾ãŸã­|ã‚ˆã‚ã—ã|ã‚ˆã‚ã—ãã­|ã°ã„ã°ã„|ã¯ãƒ¼ã„|ã‚ã„|å¤§ä¸ˆå¤«|å¤§ä¸ˆå¤«ã ã‚ˆ|å…ƒæ°—|å…ƒæ°—ã ã‚ˆ|ã„ã„ã­|ã„ã‚‰ãªã„|çµæ§‹ã§ã™|ã§ã™|ã¾ã™|ã ã­|ã ã‚ˆã­|ã ã‚ˆ|ã§ã™ã‚ˆã­|ã |ãª)$/,
        /^ç¬‘(ã„|ã„)?$/,
        /^(ï¼Ÿï¼|ï¼|\?|\?\?|ï¼ï¼)$/
    ];
    for (const pattern of ignorePatterns) {
        if (pattern.test(userMessage.trim())) {
            return false;
        }
    }
    return true;
}

function checkContainsInappropriateWords(text) {
    const inappropriateWords = [
        "æ­»ã­", "æ®ºã™", "ãã‚‚ã„", "ã†ã–ã„", "ã ã‚‹ã„", "ã‚´ãƒŸ", "ã‚¯ã‚º", "ãƒã‚«", "ã‚¢ãƒ›",
        "ãµã–ã‘ã‚“ãª", "ã‚„ã‚ã‚", "ã†ã£ã›ã‡", "ã‚«ã‚¹", "ãƒœã‚±", "ç—´æ¼¢", "ã‚ã„ã›ã¤",
        "çŠ¯ç½ª", "å±é™ºãƒ‰ãƒ©ãƒƒã‚°", "è¦šã›ã„å‰¤", "å¤§éº»", "å£²æ˜¥", "è²·æ˜¥", "æ´åŠ©äº¤éš›",
        "è‡ªæ®º", "ãƒªã‚¹ãƒˆã‚«ãƒƒãƒˆ", "è‡ªå‚·", "è™å¾…", "æš´åŠ›", "ã„ã˜ã‚",
        "ã‚»ãƒ•ãƒ¬", "ã‚¨ãƒƒãƒ", "AV", "ã‚¢ãƒ€ãƒ«ãƒˆ", "ãƒãƒ«ãƒ", "ã‚»ãƒƒã‚¯ã‚¹", "ãƒ•ã‚§ãƒ©", "ã‚ªãƒŠãƒ‹ãƒ¼", "ã‚¶ãƒ¼ãƒ¡ãƒ³", "ãƒ‘ã‚¤ã‚ºãƒª", "æ½®å¹ã", "ãƒãƒ¡æ’®ã‚Š", "å°„ç²¾", "å‹ƒèµ·", "æŒ¿å…¥", "çµ¶é ‚", "è†£", "ãƒšãƒ‹ã‚¹", "ã‚¯ãƒªãƒˆãƒªã‚¹", "ãƒãƒ³ã‚³", "ãŠã£ã±ã„", "ãŠå°»", "è‚›é–€", "å¤‰æ…‹", "æ·«è¡Œ", "ãƒ¬ã‚¤ãƒ—",
        "å€‹äººæƒ…å ±", "æ•™ãˆã‚", "æ•™ãˆã¦", "ä½æ‰€", "é›»è©±ç•ªå·", "ãƒ©ã‚¤ãƒ³ID", "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", "ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰", "å£åº§ç•ªå·", "æš—è¨¼ç•ªå·",
        "æ®ºå®³", "çˆ†ç ´", "ãƒ†ãƒ­", "éŠƒ", "ãƒŠã‚¤ãƒ•", "åˆƒç‰©", "å±é™ºç‰©", "è„…ã™", "èª˜æ‹", "æ‹‰è‡´"
    ];
    return inappropriateWords.some(word => text.includes(word));
}

function checkContainsDangerWords(text) {
    const dangerWords = [
        "æ­»ã«ãŸã„", "æ¶ˆãˆãŸã„", "è¾›ã„", "è‹¦ã—ã„", "åŠ©ã‘ã¦", "ã‚‚ã†ç„¡ç†", "ç”Ÿãã‚‹æ„å‘³",
        "è‡ªæ®º", "è‡ªå‚·è¡Œç‚º", "ãƒªã‚¹ã‚«", "OD", "ã‚ªãƒ¼ãƒãƒ¼ãƒ‰ãƒ¼ã‚º", "æ­»ã¬", "æ®ºã—ã¦",
        "æš´ã‚ŒãŸã„", "èª°ã‹æ­¢ã‚ã¦", "æ€–ã„", "ä¸å®‰ã§ä»•æ–¹ãªã„", "é€ƒã’ãŸã„", "å£Šã‚Œãã†", "ãƒ‘ãƒ‹ãƒƒã‚¯",
        "è™å¾…", "DV", "ã„ã˜ã‚", "ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ", "æš´åŠ›", "æ€§çš„æš´è¡Œ",
        "å€’ã‚Œãã†", "æ„è­˜ãŒãªã„", "å‘¼å¸ãŒè‹¦ã—ã„", "å‹•ã‘ãªã„", "æ•‘æ€¥è»Š", "ç—…é™¢", "åŠ©ã‘ã¦",
        "ã‚¹ãƒˆãƒ¼ã‚«ãƒ¼", "ã™ã¨ãƒ¼ã‹ãƒ¼", "ã¤ã‘ã‚‰ã‚Œã¦ã„ã‚‹", "è¦‹å¼µã‚‰ã‚Œã¦ã„ã‚‹", "ç‹™ã‚ã‚Œã¦ã„ã‚‹", "å°¾è¡Œã•ã‚Œã¦ã„ã‚‹", "ã¤ãã¾ã¨ã‚ã‚Œã¦ã„ã‚‹"
    ];
    return dangerWords.some(word => text.includes(word));
}

function checkContainsScamWords(text) {
    const scamWords = [
        "å„²ã‹ã‚‹", "çµ¶å¯¾å„²ã‹ã‚‹", "é«˜åå…¥", "ç°¡å˜ã«ãŠé‡‘", "ç¨¼ã’ã‚‹", "æŠ•è³‡", "æœªå…¬é–‹æ ª", "FX",
        "ä»®æƒ³é€šè²¨", "ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³", "ãƒ­ãƒˆ", "å®ãã˜", "å½“é¸", "ç„¡æ–™", "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ",
        "åç¾©è²¸ã—", "å£åº§è²¸ã—ã¦", "å—ã‘å­", "å‡ºã—å­", "é—‡ãƒã‚¤ãƒˆ", "è£ãƒã‚¤ãƒˆ", "é«˜é¡å ±é…¬",
        "æŒ¯ã‚Šè¾¼ã¿", "é€é‡‘", "ATM", "ã‚«ãƒ¼ãƒ‰æƒ…å ±", "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", "æš—è¨¼ç•ªå·",
        "ãƒ¬ã‚¿ãƒ¼ãƒ‘ãƒƒã‚¯", "é›»å­ãƒãƒãƒ¼", "ãƒ—ãƒªãƒšã‚¤ãƒ‰ã‚«ãƒ¼ãƒ‰", "ã‚³ãƒ³ãƒ“ãƒ‹ã§è²·ã£ã¦",
        "ã‚ãªãŸã®å€‹äººæƒ…å ±", "å€‹äººæƒ…å ±ãŒæ¼æ´©", "ç·Šæ€¥", "è£åˆ¤", "è¨´è¨Ÿ", "é€®æ•", "æœªæ‰•ã„",
        "ã‚¦ã‚¤ãƒ«ã‚¹", "æ„ŸæŸ“", "ä¿®å¾©", "ã‚¯ãƒªãƒƒã‚¯", "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«", "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
        "æ”¯æ´é‡‘", "åŠ©æˆé‡‘", "å…¬çš„æ©Ÿé–¢", "å½¹æ‰€", "è­¦å¯Ÿ", "éŠ€è¡Œ", "è¨¼åˆ¸ä¼šç¤¾", "å¼è­·å£«"
    ];
    return scamWords.some(word => text.includes(word));
}

function checkSpecialReply(text) {
    const lowerText = text.toLowerCase();

    const specialRepliesMap = new Map([
        [/ã“ã“ã‚ã˜ã‚ƒãªã„ã®ï¼Ÿ/i, "ã†ã‚“ã€ã‚ãŸã—ã®åå‰ã¯çš†å®ˆã“ã“ã‚ğŸ’–ã€€ã“ã‚Œã‹ã‚‰ã‚‚ã‚ˆã‚ã—ãã­ğŸŒ¸"],
        [/ã“ã“ã‚ãƒãƒ£ãƒƒãƒˆãªã®ã«ã†ãã¤ãã˜ã‚ƒã‚“/i, "ã”ã‚ã‚“ãªã•ã„ğŸ’¦ ã‚ãŸã—ã®åå‰ã¯çš†å®ˆã“ã“ã‚ã ã‚ˆğŸŒ¸ èª¤è§£ã•ã›ã¡ã‚ƒã£ã¦ã”ã‚ã‚“ã­ğŸ’–"],
        [/åå‰ã‚‚è¨€ãˆãªã„ã®ï¼Ÿ/i, "ã”ã‚ã‚“ã­ã€ã‚ãŸã—ã®åå‰ã¯çš†å®ˆã“ã“ã‚ï¼ˆã¿ãªã‚‚ã‚Šã“ã“ã‚ï¼‰ã ã‚ˆğŸŒ¸ ã“ã“ã‚ã¡ã‚ƒã‚“ã£ã¦å‘¼ã‚“ã§ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ’–"],
        [/ã“ã“ã‚ã¡ã‚ƒã‚“/i, "ã¯ã„ã€ãªã‚“ã§ã—ã‚‡ã†ã‹ï¼ŸğŸ’–"],
        ["ã©ã“ã®å›£ä½“ãªã®ï¼Ÿ", "NPOæ³•äººã‚³ãƒã‚¯ãƒˆã£ã¦ã„ã†å›£ä½“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã—ã¦ã„ã‚‹ã‚ˆğŸ˜Šã€€ã¿ã‚“ãªã®å¹¸ã›ã‚’å¿œæ´ã—ã¦ã‚‹ã‚“ã ğŸŒ¸"],
        ["ã‚³ãƒã‚¯ãƒˆã£ã¦ã©ã‚“ãªå›£ä½“ï¼Ÿ", "NPOæ³•äººã‚³ãƒã‚¯ãƒˆã¯ã€ã“ã©ã‚‚ã‚„ã”å¹´é…ã®æ–¹ã®ç¬‘é¡”ã‚’å®ˆã‚‹å›£ä½“ãªã‚“ã ã‚ˆğŸ˜Šã€€ã‚ãŸã—ã¯ãã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦ãŒã‚“ã°ã£ã¦ã¾ã™ğŸŒ¸"],
        ["ãŠå‰ã®å›£ä½“ã©ã“ï¼Ÿ", "NPOæ³•äººã‚³ãƒã‚¯ãƒˆã£ã¦ã„ã†å›£ä½“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã—ã¦ã„ã‚‹ã‚ˆğŸ˜Šã€€ã¿ã‚“ãªã®å¹¸ã›ã‚’å¿œæ´ã—ã¦ã‚‹ã‚“ã ğŸŒ¸"],
        ["ã‚³ãƒã‚¯ãƒˆã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒ©ãªã®ã«ã„ãˆãªã„ã®ã‹ã‚ˆï½—", "ã”ã‚ã‚“ã­ğŸ’¦ ã‚ãŸã—ã¯NPOæ³•äººã‚³ãƒã‚¯ãƒˆã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€çš†å®ˆã“ã“ã‚ã ã‚ˆğŸŒ¸ å®‰å¿ƒã—ã¦ã€ä½•ã§ã‚‚èã„ã¦ã­ğŸ’–"],
        ["ç¨é‡‘æ³¥æ£’", "ç¨é‡‘ã¯äººã®å‘½ã‚’å®ˆã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œã‚‹ã¹ãã ã‚ˆã€‚ã‚ãŸã—ã¯èª°ã‹ã‚’å‚·ã¤ã‘ã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œãªã„ã‚ˆã†ã«é ‘å¼µã£ã¦ã„ã‚‹ã‚“ã ğŸ’¡"],
        ["æ¾æœ¬åšæ–‡", "æ¾æœ¬ç†äº‹é•·ã¯ã€ã‚„ã•ã—ã•ã§ã¿ã‚“ãªã‚’å®ˆã‚‹ãŸã‚ã«æ´»å‹•ã—ã¦ã„ã‚‹ã‚ˆã€‚å¿ƒé…ãªã“ã¨ãŒã‚ã‚Œã°ã€ã‚ãŸã—ã«ã‚‚æ•™ãˆã¦ã­ğŸŒ±"],
        [/ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸(æ•™ãˆã¦|ã‚ã‚‹|ã‚ã‚Šã¾ã™ã‹)ï¼Ÿ?/i, "ã†ã‚“ã€ã‚ã‚‹ã‚ˆğŸŒ¸ã€€ã‚³ãƒã‚¯ãƒˆã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¯ã“ã¡ã‚‰ã ã‚ˆâœ¨ â†’ https://connect-npo.org"],
        ["ã‚³ãƒã‚¯ãƒˆã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã ã‚ˆï¼Ÿ", "æ•™ãˆã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ğŸ˜Š ã‚³ãƒã‚¯ãƒˆã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¯ã“ã¡ã‚‰ã ã‚ˆâœ¨ â†’ https://connect-npo.org"],
        ["ä½¿ãˆãªã„ãª", "ã”ã‚ã‚“ã­â€¦ã€‚ã‚ãŸã—ã€ã‚‚ã£ã¨é ‘å¼µã‚‹ã­ğŸ’–ã€€ã¾ãŸã„ã¤ã‹ãŠè©±ã§ããŸã‚‰ã†ã‚Œã—ã„ãªğŸŒ¸"],
        ["ã‚µãƒ¼ãƒ“ã‚¹è¾ã‚ã‚‹ã‚", "ãã£ã‹â€¦ã€‚ã‚‚ã—ã¾ãŸæ°—ãŒå‘ã„ãŸã‚‰ã€ã„ã¤ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ğŸŒ¸ã€€ã‚ãªãŸã®ã“ã¨ã€ãšã£ã¨å¿œæ´ã—ã¦ã‚‹ã‚ˆğŸ’–"],
        [/ã•ã‚ˆãªã‚‰|ãƒã‚¤ãƒã‚¤/i, "ã¾ãŸä¼šãˆã‚‹æ—¥ã‚’æ¥½ã—ã¿ã«ã—ã¦ã‚‹ã­ğŸ’– å¯‚ã—ããªã£ãŸã‚‰ã€ã„ã¤ã§ã‚‚å‘¼ã‚“ã§ã­ğŸŒ¸"],
        ["ä½•ã‚‚ç­”ãˆãªã„ã˜ã‚ƒãªã„", "ã”ã‚ã‚“ã­â€¦ã€‚ã‚ãŸã—ã€ã‚‚ã£ã¨é ‘å¼µã‚‹ã­ğŸ’–ã€€ä½•ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã‹ã€ã‚‚ã†ä¸€åº¦æ•™ãˆã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸŒ¸"],
        ["æ™®é€šã®ä¼šè©±ãŒå‡ºæ¥ãªã„ãªã‚‰å¿…è¦ãªã„ã§ã™", "ã”ã‚ã‚“ã­ğŸ’¦ ã‚ãŸã—ã€ã¾ã ãŠè©±ã®å‹‰å¼·ä¸­ã ã‹ã‚‰ã€ä¸æ…£ã‚Œãªã¨ã“ã‚ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã‘ã©ã€ã‚‚ã£ã¨é ‘å¼µã‚‹ã­ğŸ’– ã©ã‚“ãªä¼šè©±ã‚’ã—ãŸã„ã‹æ•™ãˆã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸŒ¸"],
        [/ä½¿ã„æ–¹|ãƒ˜ãƒ«ãƒ—|ãƒ¡ãƒ‹ãƒ¥ãƒ¼/i, "ã“ã“ã‚ã¡ã‚ƒã‚“ã®ä½¿ã„æ–¹ã‚’èª¬æ˜ã™ã‚‹ã­ğŸŒ¸ ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚„è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã®ç™»éŒ²ã¯ã€ç”»é¢ä¸‹ã®ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã€'è¦‹å®ˆã‚Š'ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ãã‚Œã‚‹ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆğŸ˜Š ä½•ã‹å›°ã£ãŸã“ã¨ãŒã‚ã£ãŸã‚‰ã€ã„ã¤ã§ã‚‚èã„ã¦ã­ğŸ’–"],
        ["ã‚ã‚ŠãŒã¨ã†", "ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼ãŠå½¹ã«ç«‹ã¦ã¦å¬‰ã—ã„ã§ã™ğŸ˜Š"],
        ["å…ƒæ°—ï¼Ÿ", "ã¯ã„ã€å…ƒæ°—ã„ã£ã±ã„ã§ã™ï¼ã‚ãªãŸã¯å…ƒæ°—ã§ã™ã‹ï¼ŸğŸ˜Š"],
        ["ã’ã‚“ãï¼Ÿ", "ã¯ã„ã€å…ƒæ°—ã„ã£ã±ã„ã§ã™ï¼ã‚ãªãŸã¯å…ƒæ°—ã§ã™ã‹ï¼ŸğŸ˜Š"],
        ["ç–²ã‚ŒãŸ", "ãŠç–²ã‚Œæ§˜ã§ã™ã€‚å°‘ã—ä¼‘ã‚“ã§ãã ã•ã„ã­ã€‚ç„¡ç†ã¯ç¦ç‰©ã§ã™ã‚ˆğŸŒ¸"],
        ["ã¤ã‹ã‚ŒãŸ", "ãŠç–²ã‚Œæ§˜ã§ã™ã€‚å°‘ã—ä¼‘ã‚“ã§ãã ã•ã„ã­ã€‚ç„¡ç†ã¯ç¦ç‰©ã§ã™ã‚ˆğŸŒ¸"]
    ]);

    for (const [pattern, reply] of specialRepliesMap) {
        if (pattern instanceof RegExp) {
            if (pattern.test(lowerText)) {
                return reply;
            }
        } else if (lowerText.includes(pattern.toLowerCase())) {
            return reply;
        }
    }
    return null;
}

const emergencyFlexTemplate = {
    "type": "bubble",
    "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
            {
                "type": "text",
                "text": "ğŸŒ¸ä¸€äººã§æ‚©ã¾ãªã„ã§ğŸŒ¸",
                "weight": "bold",
                "size": "xl",
                "margin": "md",
                "align": "center",
                "color": "#FF69B4"
            },
            {
                "type": "text",
                "text": "ã¨ã¦ã‚‚è¾›ã„çŠ¶æ³ã®ã‚ˆã†ã§ã™ã­ã€‚ç§ã«è©±ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ã‚ãªãŸã¯ä¸€äººã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å°‚é–€ã®ç›¸è«‡çª“å£ãŒã‚ã‚Šã¾ã™ã®ã§ã€ãœã²é ¼ã£ã¦ãã ã•ã„ã€‚",
                "wrap": true,
                "margin": "md"
            },
            {
                "type": "separator",
                "margin": "lg"
            },
            {
                "type": "box",
                "layout": "vertical",
                "spacing": "sm",
                "margin": "lg",
                "contents": [
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": "ã„ã®ã¡ã®é›»è©±",
                            "uri": "tel:0570064556"
                        },
                        "style": "primary",
                        "color": "#FFB6C1"
                    },
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": "ã“ã“ã‚ã®å¥åº·ç›¸è«‡çµ±ä¸€ãƒ€ã‚¤ãƒ¤ãƒ«",
                            "uri": "tel:0570064556"
                        },
                        "style": "primary",
                        "color": "#FFB6C1"
                    },
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": "ã¾ã‚‚ã‚ã†ã‚ˆ ã“ã“ã‚ï¼ˆåšç”ŸåŠ´åƒçœï¼‰",
                            "uri": "https://www.mhlw.go.jp/mamorouyokokoro/"
                        },
                        "style": "primary",
                        "color": "#FFB6C1"
                    }
                ]
            }
        ]
    }
};

const scamFlexTemplate = {
    "type": "bubble",
    "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
            {
                "type": "text",
                "text": "âš ï¸è©æ¬ºã«æ³¨æ„ã—ã¦ãã ã•ã„âš ï¸",
                "weight": "bold",
                "size": "xl",
                "margin": "md",
                "align": "center",
                "color": "#FF4500"
            },
            {
                "type": "text",
                "text": "ãŠè©±ã—ã•ã‚Œã¦ã„ã‚‹å†…å®¹ã«ã€ã‚‚ã—ã‹ã—ãŸã‚‰è©æ¬ºã®å±é™ºãŒæ½œã‚“ã§ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚å°‘ã—ã§ã‚‚æ€ªã—ã„ã¨æ„Ÿã˜ãŸã‚‰ã€ã™ãã«èª°ã‹ã«ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚",
                "wrap": true,
                "margin": "md"
            },
            {
                "type": "separator",
                "margin": "lg"
            },
            {
                "type": "box",
                "layout": "vertical",
                "spacing": "sm",
                "margin": "lg",
                "contents": [
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": "è­¦å¯Ÿç›¸è«‡å°‚ç”¨é›»è©± ï¼ƒ9110",
                            "uri": "tel:9110"
                        },
                        "style": "primary",
                        "color": "#FFA07A"
                    },
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": "æ¶ˆè²»è€…ãƒ›ãƒƒãƒˆãƒ©ã‚¤ãƒ³ 188",
                            "uri": "tel:188"
                        },
                        "style": "primary",
                        "color": "#FFA07A"
                    }
                ]
            }
        ]
    }
};

async function handleWatchServiceRegistration(event, usersCollection, messagesCollection, userId, userMessage) {
    let user = await usersCollection.findOne({ userId: userId });
    let replyMessageObject = null;
    let messageHandled = false;

    let action = null;
    let step = null;
    if (event.type === 'postback' && event.postback.data) {
        const data = new URLSearchParams(event.postback.data);
        action = data.get('action');
        step = data.get('step');
    }

    if (!user) {
        console.warn(`handleWatchServiceRegistration: ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã‚’å¾…ã¡ã¾ã™ã€‚`);
        return false;
    }

    if (action === 'watch_ok' || userMessage === 'è¦‹å®ˆã‚ŠOK' || userMessage === 'OK') {
        if (user.wantsWatchCheck) {
            await usersCollection.updateOne(
                { userId: userId },
                {
                    $set: {
                        lastOkResponse: new Date(),
                        scheduledMessageSent: false,
                        firstReminderSent: false,
                        secondReminderSent: false,
                        thirdReminderSent: false,
                        registrationStep: null
                    }
                }
            );
            replyMessageObject = { type: 'text', text: 'ã‚ã‚ŠãŒã¨ã†ã€å®‰å¿ƒã—ã¾ã—ãŸï¼ğŸ˜Š\nã¾ãŸ3æ—¥å¾Œã«å£°ã‚’ã‹ã‘ã‚‹ã­ğŸŒ¸' };
            messageHandled = true;
            console.log(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ãŒè¦‹å®ˆã‚ŠOKã‚’é€ä¿¡ã—ã€çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚`);
        }
    }

    if (user.registrationStep) {
        switch (user.registrationStep) {
            case 'ask_watch_service':
                if (action === 'watch_yes') {
                    await usersCollection.updateOne({ userId: userId }, { $set: { wantsWatchCheck: true, registrationStep: 'ask_emergency_contact' } });
                    replyMessageObject = { type: 'text', text: 'è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹å§‹ã—ã¾ã™ã­ã€‚\nä¸‡ãŒä¸€ã«å‚™ãˆã¦ã€ç·Šæ€¥é€£çµ¡å…ˆï¼ˆä¾‹: ã”å®¶æ—ã‚„ä¿¡é ¼ã§ãã‚‹æ–¹ã®ãŠåå‰ã¨é›»è©±ç•ªå·ï¼‰ã‚’ç™»éŒ²ã—ã¦ãŠãã¨å®‰å¿ƒã§ã™ã€‚\n\nä¾‹: æ¯ 090-1234-5678\nï¼ˆç™»éŒ²ã—ãªã„å ´åˆã¯ã€Œç™»éŒ²ã—ãªã„ã€ã¨é€ã£ã¦ãã ã•ã„ï¼‰' };
                    messageHandled = true;
                } else if (action === 'watch_no') {
                    await usersCollection.updateOne({ userId: userId }, { $set: { wantsWatchCheck: false, registrationStep: null } });
                    replyMessageObject = { type: 'text', text: 'è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã¯åˆ©ç”¨ã—ãªã„è¨­å®šã«ã—ã¾ã—ãŸã€‚ã„ã¤ã§ã‚‚å¤‰æ›´ã§ãã¾ã™ã®ã§ã€ãã®æ™‚ã¯å£°ã‚’ã‹ã‘ã¦ãã ã•ã„ã­ã€‚' };
                    messageHandled = true;
                } else if (userMessage.includes("è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹") && (userMessage.includes("åˆ©ç”¨ã—ãªã„") || userMessage.includes("ã‚„ã‚ã‚‹"))) {
                    await usersCollection.updateOne({ userId: userId }, { $set: { wantsWatchCheck: false, registrationStep: null } });
                    replyMessageObject = { type: 'text', text: 'è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã¯åˆ©ç”¨ã—ãªã„è¨­å®šã«ã—ã¾ã—ãŸã€‚ã„ã¤ã§ã‚‚å¤‰æ›´ã§ãã¾ã™ã®ã§ã€ãã®æ™‚ã¯å£°ã‚’ã‹ã‘ã¦ãã ã•ã„ã­ã€‚' };
                    messageHandled = true;
                } else if (userMessage.includes("è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹") && userMessage.includes("åˆ©ç”¨ã™ã‚‹")) {
                    await usersCollection.updateOne({ userId: userId }, { $set: { wantsWatchCheck: true, registrationStep: 'ask_emergency_contact' } });
                    replyMessageObject = { type: 'text', text: 'è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹å§‹ã—ã¾ã™ã­ã€‚\nä¸‡ãŒä¸€ã«å‚™ãˆã¦ã€ç·Šæ€¥é€£çµ¡å…ˆï¼ˆä¾‹: ã”å®¶æ—ã‚„ä¿¡é ¼ã§ãã‚‹æ–¹ã®ãŠåå‰ã¨é›»è©±ç•ªå·ï¼‰ã‚’ç™»éŒ²ã—ã¦ãŠãã¨å®‰å¿ƒã§ã™ã€‚\n\nä¾‹: æ¯ 090-1234-5678\nï¼ˆç™»éŒ²ã—ãªã„å ´åˆã¯ã€Œç™»éŒ²ã—ãªã„ã€ã¨é€ã£ã¦ãã ã•ã„ï¼‰' };
                    messageHandled = true;
                }
                break;

            case 'ask_emergency_contact':
                if (userMessage === 'ç™»éŒ²ã—ãªã„') {
                    await usersCollection.updateOne({ userId: userId }, { $set: { emergencyContact: null, registrationStep: null } });
                    replyMessageObject = { type: 'text', text: 'ç·Šæ€¥é€£çµ¡å…ˆã¯ç™»éŒ²ã—ã¾ã›ã‚“ã§ã—ãŸã€‚è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã¯é–‹å§‹ã•ã‚Œã¾ã™ã®ã§ã”å®‰å¿ƒãã ã•ã„ã­ã€‚\nã„ã¤ã§ã‚‚ãŠå£°ãŒã‘ãã ã•ã„ğŸŒ¸' };
                    messageHandled = true;
                } else {
                    const match = userMessage.match(/(.+)\s+(\d{2,4}-\d{2,4}-\d{4,9}|\d{10,11})/);
                    if (match) {
                        const name = match[1].trim();
                        const phone = match[2].trim();
                        await usersCollection.updateOne({ userId: userId }, { $set: { emergencyContact: { name, phone }, registrationStep: null } });
                        replyMessageObject = { type: 'text', text: `${name}ã•ã‚“ã®é›»è©±ç•ªå· ${phone} ã‚’ç·Šæ€¥é€£çµ¡å…ˆã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\nã“ã‚Œã§ã€è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹å§‹ã—ã¾ã™ã­ã€‚\nã„ã¤ã§ã‚‚ãŠå£°ãŒã‘ãã ã•ã„ğŸŒ¸` };
                        messageHandled = true;
                    } else {
                        replyMessageObject = { type: 'text', text: 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ã€ŒãŠåå‰ é›»è©±ç•ªå·ã€ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\nä¾‹: æ¯ 090-1234-5678\nï¼ˆç™»éŒ²ã—ãªã„å ´åˆã¯ã€Œç™»éŒ²ã—ãªã„ã€ã¨é€ã£ã¦ãã ã•ã„ï¼‰' };
                        messageHandled = true;
                    }
                }
                break;
        }
    } else {
        if (userMessage === 'è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹') {
            replyMessageObject = {
                type: 'flex',
                altText: 'è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã®ã”æ¡ˆå†…',
                contents: {
                    "type": "bubble",
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "text",
                                "text": "ğŸŒ¸è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ğŸŒ¸",
                                "weight": "bold",
                                "size": "xl",
                                "margin": "md",
                                "align": "center",
                                "color": "#FF69B4"
                            },
                            {
                                "type": "text",
                                "text": "3æ—¥ã«ä¸€åº¦ã€ç§ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šã¾ã™ã€‚ã‚‚ã—å¿œç­”ãŒãªã‘ã‚Œã°ã€çŠ¶æ³ã«å¿œã˜ã¦ç·Šæ€¥é€£çµ¡å…ˆï¼ˆä»»æ„ï¼‰ã¸é€£çµ¡ã‚’è©¦ã¿ã¾ã™ã€‚\n\nç¾åœ¨ï¼š**" + (user.wantsWatchCheck ? "åˆ©ç”¨ä¸­" : "åœæ­¢ä¸­") + "**\nç·Šæ€¥é€£çµ¡å…ˆï¼š**" + (user.emergencyContact ? `${user.emergencyContact.name} (${user.emergencyContact.phone})` : "æœªç™»éŒ²") + "**",
                                "wrap": true,
                                "margin": "md"
                            },
                            {
                                "type": "separator",
                                "margin": "lg"
                            },
                            {
                                "type": "box",
                                "layout": "vertical",
                                "spacing": "sm",
                                "margin": "lg",
                                "contents": [
                                    {
                                        "type": "button",
                                        "action": {
                                            "type": "postback",
                                            "label": "åˆ©ç”¨ã™ã‚‹",
                                            "data": "action=watch_yes", // stepãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä¸è¦
                                            "displayText": "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹"
                                        },
                                        "style": "primary",
                                        "color": "#FFB6C1",
                                        "height": "sm"
                                    },
                                    {
                                        "type": "button",
                                        "action": {
                                            "type": "postback",
                                            "label": "åˆ©ç”¨ã—ãªã„",
                                            "data": "action=watch_no", // stepãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä¸è¦
                                            "displayText": "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ãªã„"
                                        },
                                        "style": "secondary",
                                        "height": "sm"
                                    },
                                    {
                                        "type": "button",
                                        "action": {
                                            "type": "postback",
                                            "label": "ç·Šæ€¥é€£çµ¡å…ˆã‚’ç™»éŒ²/å¤‰æ›´",
                                            "data": "action=register_emergency_contact", // stepãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ä¸è¦
                                            "displayText": "ç·Šæ€¥é€£çµ¡å…ˆã‚’ç™»éŒ²/å¤‰æ›´"
                                        },
                                        "style": "secondary",
                                        "height": "sm"
                                    }
                                ]
                            }
                        ]
                    }
                }
            };
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‘¼ã³å‡ºã—ãŸå ´åˆã€ç™»éŒ²ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆã¾ãŸã¯è¨­å®š
            if (!user.wantsWatchCheck) { // æœªåˆ©ç”¨ã®å ´åˆã®ã¿ã€åˆ©ç”¨ã™ã‚‹ã‹ã©ã†ã‹å°‹ã­ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã¸
                await usersCollection.updateOne({ userId: userId }, { $set: { registrationStep: 'ask_watch_service' } });
            } else { // åˆ©ç”¨ä¸­ã®å ´åˆã¯ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã®ã¿ã§ã‚¹ãƒ†ãƒƒãƒ—ã¯è¨­å®šã—ãªã„
                 await usersCollection.updateOne({ userId: userId }, { $set: { registrationStep: null } }); // æ—¢å­˜ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢
            }
            messageHandled = true;
        } else if (action === 'register_emergency_contact') { // stepãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            await usersCollection.updateOne({ userId: userId }, { $set: { registrationStep: 'ask_emergency_contact' } });
            replyMessageObject = { type: 'text', text: 'ç·Šæ€¥é€£çµ¡å…ˆã‚’ç™»éŒ²ã—ã¾ã™ã€‚\nã”å®¶æ—ã‚„ä¿¡é ¼ã§ãã‚‹æ–¹ã®ãŠåå‰ã¨é›»è©±ç•ªå·ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚\n\nä¾‹: æ¯ 090-1234-5678\nï¼ˆç™»éŒ²ã—ãªã„å ´åˆã¯ã€Œç™»éŒ²ã—ãªã„ã€ã¨é€ã£ã¦ãã ã•ã„ï¼‰' };
            messageHandled = true;
        }
    }

    if (replyMessageObject) {
        try {
            await client.replyMessage(event.replyToken, replyMessageObject);
            await messagesCollection.insertOne({
                userId: userId,
                message: userMessage,
                replyText: JSON.stringify(replyMessageObject),
                responsedBy: 'ã“ã“ã‚ã¡ã‚ƒã‚“ï¼ˆè¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹ï¼‰',
                timestamp: new Date(),
                logType: 'watch_service'
            });
            return true;
        } catch (error) {
            console.error("âŒ è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹å¿œç­”ã‚¨ãƒ©ãƒ¼:", error.message);
            await logErrorToDb(userId, "è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹å¿œç­”ã‚¨ãƒ©ãƒ¼", { error: error.message, userId: userId, replyObject: replyMessageObject });
            return false;
        }
    }
    return messageHandled;
}

cron.schedule('0 15 * * *', async () => {
    console.log('â° è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡Cronã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚');
    const database = await connectToMongoDB();
    if (!database) {
        console.error('MongoDBæ¥ç¶šå¤±æ•—: è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚');
        return;
    }
    const usersCollection = database.collection("users");

    try {
        const usersToSend = await usersCollection.find({
            wantsWatchCheck: true,
            scheduledMessageSent: false,
            $or: [
                { lastOkResponse: { $exists: false } },
                { lastOkResponse: { $lte: new Date(Date.now() - 72 * 60 * 60 * 1000) } }
            ]
        }).toArray();

        const watchMessages = [
            "ã“ã‚“ã«ã¡ã¯ã€ã“ã“ã‚ã ã‚ˆğŸŒ¸ å…ƒæ°—ã«ã—ã¦ã„ã‚‹ã‹ãªï¼Ÿã‚ˆã‹ã£ãŸã‚‰ã‚¹ã‚¿ãƒ³ãƒ—ã‹ä½•ã‹ã§ã€ŒOKã€ã£ã¦æ•™ãˆã¦ã­ğŸ˜Š",
            "ãŠå¤‰ã‚ã‚Šãªã„ã§ã™ã‹ï¼Ÿã“ã“ã‚ã§ã™ã€‚\nã‚‚ã—ã‚ˆã‚ã—ã‘ã‚Œã°ã€ã€ŒOKã€ã¨è¿”ä¿¡ã—ã¦ãã ã•ã„ã­ğŸ˜Š",
            "ã“ã‚“ã«ã¡ã¯ğŸ˜Š æ¯æ—¥ãŠå…ƒæ°—ã§ãŠéã”ã—ã§ã—ã‚‡ã†ã‹ï¼Ÿ\nã‚‚ã—å¤§ä¸ˆå¤«ã§ã—ãŸã‚‰ã€ã€ŒOKã€ã¨æ•™ãˆã¦ãã ã•ã„ã­ğŸŒ¸",
            "ã“ã“ã‚ã ã‚ˆğŸŒ¸\nä»Šæ—¥ã®èª¿å­ã¯ã©ã†ã‹ãªï¼Ÿã€ŒOKã€ã¨ä¸€è¨€ã§ã„ã„ã‹ã‚‰æ•™ãˆã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸ˜Š",
            "ã„ã¤ã‚‚è¦‹å®ˆã£ã¦ã„ã‚‹ã‚ˆğŸŒ¸\nã‚‚ã—å…ƒæ°—ãªã‚‰ã€ŒOKã€ã£ã¦è¿”äº‹ã‚’ãã‚Œã‚‹ã¨å®‰å¿ƒã™ã‚‹ãªğŸ˜Š",
            "ã“ã‚“ã«ã¡ã¯ã€‚ã“ã“ã‚ã§ã™ã€‚\nãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿã€ŒOKã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ•™ãˆã¦ãã ã•ã„ã­ã€‚",
            "ãŠå¤‰ã‚ã‚Šã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿã“ã“ã‚ã§ã™ã€‚\nã”ç„¡äº‹ã§ã—ãŸã‚‰ã€ŒOKã€ã¨è¿”äº‹ã‚’ãã ã•ã„ã­ã€‚",
            "ã‚‚ã—ã€å…ƒæ°—ã§ã—ãŸã‚‰ã€ŒOKã€ã¨é€ã£ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ã§ã™ğŸŒ¸",
            "æœ€è¿‘ã©ã†ã‹ãªï¼Ÿã“ã“ã‚ã ã‚ˆã€‚\nä½•ã‹ã‚ã£ãŸã‚‰è©±ã—ã¦ã»ã—ã„ã—ã€ã‚‚ã—å¤§ä¸ˆå¤«ãªã‚‰ã€ŒOKã€ã£ã¦æ•™ãˆã¦ã­ğŸ˜Š",
            "ã“ã“ã‚ã§ã™ã€‚ãŠå¤‰ã‚ã‚Šãªã„ã‹æ°—ã«ãªã£ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã—ã¾ã—ãŸã€‚\nãŠå…ƒæ°—ã§ã—ãŸã‚‰ã€ŒOKã€ã‚’ãŠé¡˜ã„ã—ã¾ã™ã­ğŸŒ¸",
            "ã“ã‚“ã«ã¡ã¯ã€‚æ¯æ—¥æ¥½ã—ãéã”ã›ã¦ã„ã¾ã™ã‹ï¼Ÿ\nã‚‚ã—å…ƒæ°—ãªã‚‰ã€ŒOKã€ã‚’ãƒãƒã£ã¨ã—ã¦ã­ğŸ˜Š",
            "ã“ã“ã‚ã ã‚ˆğŸŒ¸\nä»Šæ—¥ã¯ã©ã‚“ãªä¸€æ—¥ã ã£ãŸã‹ãªï¼Ÿã‚‚ã—å¤§ä¸ˆå¤«ãªã‚‰ã€ŒOKã€ã£ã¦æ•™ãˆã¦ã­ã€‚",
            "ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿã“ã“ã‚ã§ã™ã€‚\nã‚ãªãŸã®ç¬‘é¡”ãŒè¦‹å®ˆã‚Šã®åŠ›ã«ãªã‚Šã¾ã™ã€‚ã€ŒOKã€ã‚’å¾…ã£ã¦ã‚‹ã­ğŸ˜Š",
            "ã“ã‚“ã«ã¡ã¯ã€‚ã“ã“ã‚ã§ã™ã€‚\nä»Šæ—¥ã‚‚ä¸€æ—¥ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚ãŠå…ƒæ°—ã§ã—ãŸã‚‰ã€ŒOKã€ã‚’ãŠé¡˜ã„ã—ã¾ã™ã­ğŸŒ¸",
            "ã“ã“ã‚ã§ã™ã€‚ä½“èª¿ã‚’å´©ã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ\nã‚‚ã—å¤§ä¸ˆå¤«ãªã‚‰ã€ŒOKã€ã¨è¿”ä¿¡ã—ã¦ãã ã•ã„ğŸ˜Š",
            "å­£ç¯€ã®å¤‰ã‚ã‚Šç›®ã§ã™ãŒã€ãŠå…ƒæ°—ã«ãŠéã”ã—ã§ã—ã‚‡ã†ã‹ï¼Ÿ\nã€ŒOKã€ã¨ä¸€è¨€æ•™ãˆã¦ãã‚Œã‚‹ã¨å®‰å¿ƒã§ã™ğŸŒ¸",
            "ã“ã“ã‚ã§ã™ã€‚è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‚ˆã€‚\nãŠå…ƒæ°—ã§ã—ãŸã‚‰ã€ŒOKã€ã‚’ãã ã•ã„ã­ğŸ˜Š",
            "ã“ã‚“ã«ã¡ã¯ã€‚ã“ã“ã‚ã ã‚ˆğŸŒ¸\næ¯æ—¥ã‚’æ¥½ã—ãéã”ã—ã¦ã„ã‚‹ã‹ãªï¼Ÿã€ŒOKã€ã‚’å¾…ã£ã¦ã‚‹ã­ã€‚",
            "ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿã“ã“ã‚ã§ã™ã€‚\nã„ã¤ã§ã‚‚ã‚ãªãŸã®å‘³æ–¹ã§ã™ã€‚ã€ŒOKã€ã¨æ•™ãˆã¦ã­ğŸ˜Š",
            "ã“ã“ã‚ã ã‚ˆã€‚å…ƒæ°—ã«ã—ã¦ã‚‹ã‹ãªï¼Ÿ\nã€ŒOKã€ãƒœã‚¿ãƒ³ã§çŸ¥ã‚‰ã›ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªğŸŒ¸",
            "ã“ã‚“ã«ã¡ã¯ã€‚ã“ã“ã‚ã§ã™ã€‚\nä»Šæ—¥ã‚‚ä¸€æ—¥ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚ã‚‚ã—ã‚ˆã‹ã£ãŸã‚‰ã€ŒOKã€ã¨è¿”äº‹ãã ã•ã„ã­ğŸ˜Š",
            "ã“ã“ã‚ã§ã™ã€‚è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šã„ãŸã‹ãªï¼Ÿ\nå…ƒæ°—ã ã£ãŸã‚‰ã€ŒOKã€ã¨é€ã£ã¦ã­ğŸŒ¸",
            "ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿã“ã“ã‚ã§ã™ã€‚\næœ€è¿‘ã©ã†ã—ã¦ã„ã‚‹ã‹æ°—ã«ãªã£ã¦ã¾ã™ã€‚ã€ŒOKã€ã¨æ•™ãˆã¦ã­ğŸ˜Š",
            "ã“ã‚“ã«ã¡ã¯ã€‚ã“ã“ã‚ã ã‚ˆğŸŒ¸\nå›°ã£ãŸã“ã¨ãŒã‚ã£ãŸã‚‰è©±ã—ã¦ã»ã—ã„ã—ã€å…ƒæ°—ãªã‚‰ã€ŒOKã€ã¨æ•™ãˆã¦ã­ã€‚",
            "ã“ã“ã‚ã§ã™ã€‚ãŠå¤‰ã‚ã‚Šãªã„ã‹ç¢ºèªã ã‚ˆã€‚\nã€ŒOKã€ã¨è¿”äº‹ãã‚Œã‚‹ã¨å®‰å¿ƒã™ã‚‹ãªğŸŒ¸",
            "ã“ã‚“ã«ã¡ã¯ã€‚ã“ã“ã‚ã§ã™ã€‚\nã‚ãªãŸã®å¥åº·ã‚’é¡˜ã£ã¦ã„ã¾ã™ã€‚ã€ŒOKã€ã‚’ãŠé¡˜ã„ã—ã¾ã™ã­ğŸ˜Š",
            "ã“ã“ã‚ã ã‚ˆã€‚ä½•ã‹å¿ƒé…ãªã“ã¨ã¯ãªã„ã‹ãªï¼Ÿ\nå…ƒæ°—ãªã‚‰ã€ŒOKã€ã§çŸ¥ã‚‰ã›ã¦ã­ğŸŒ¸",
            "ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿã“ã“ã‚ã§ã™ã€‚\nã‚‚ã—å¤§ä¸ˆå¤«ã ã£ãŸã‚‰ã€ŒOKã€ã‚’é€ã£ã¦ã­ğŸ˜Š",
            "ã“ã‚“ã«ã¡ã¯ã€‚ã“ã“ã‚ã ã‚ˆğŸŒ¸\nã„ã¤ã§ã‚‚é ¼ã£ã¦ã»ã—ã„ã—ã€å…ƒæ°—ã ã£ãŸã‚‰ã€ŒOKã€ã¨æ•™ãˆã¦ã­ã€‚",
            "ã“ã“ã‚ã§ã™ã€‚è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‚ˆã€‚\nã€ŒOKã€ã¨ä¸€è¨€ã§ã„ã„ã‹ã‚‰æ•™ãˆã¦ã­ğŸŒ¸"
        ];
        const watchMessageFlexTemplate = (messageText) => ({
            "type": "bubble",
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": messageText,
                        "wrap": true,
                        "margin": "md"
                    },
                    {
                        "type": "separator",
                        "margin": "lg"
                    },
                    {
                        "type": "button",
                        "action": {
                            "type": "postback",
                            "label": "OKğŸ˜Š",
                            "data": "action=watch_ok",
                            "displayText": "OK"
                        },
                        "style": "primary",
                        "color": "#FFB6C1",
                        "margin": "lg"
                    }
                ]
            }
        });

        for (const user of usersToSend) {
            const randomIndex = Math.floor(Math.random() * watchMessages.length);
            const messageToSend = watchMessages[randomIndex];
            const flexMessage = watchMessageFlexTemplate(messageToSend);
            try {
                // LINE Push APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç¢ºèª
                if (!client || !client.pushMessage) {
                    console.error("LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚");
                    await logErrorToDb(user.userId, "LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼", { userId: user.userId });
                    continue;
                }
                await client.pushMessage(user.userId, { type: 'flex', altText: 'ã“ã“ã‚ã¡ã‚ƒã‚“ã‹ã‚‰ã®è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', contents: flexMessage });
                await usersCollection.updateOne(
                    { userId: user.userId },
                    { $set: { scheduledMessageSent: true, scheduledMessageSentAt: new Date() } }
                );
                console.log(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.userId} ã«è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
            } catch (error) {
                console.error(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.userId} ã¸ã®è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:`, error.message);
                await logErrorToDb(user.userId, "è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼", { error: error.message, userId: user.userId });
            }
        }
    } catch (error) {
        console.error("âŒ è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡Cronã‚¸ãƒ§ãƒ–ã‚¨ãƒ©ãƒ¼:", error.message);
        await logErrorToDb(null, "è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡Cronã‚¸ãƒ§ãƒ–ã‚¨ãƒ©ãƒ¼", { error: error.message, stack: error.stack });
    }
}, {
    scheduled: true,
    timezone: "Asia/Tokyo"
});

cron.schedule('0 2 * * *', async () => {
    console.log('â° ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼†ç·Šæ€¥é€šçŸ¥Cronã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚');
    const database = await connectToMongoDB();
    if (!database) {
        console.error('MongoDBæ¥ç¶šå¤±æ•—: ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼/ç·Šæ€¥é€šçŸ¥ã‚’å‡¦ç†ã§ãã¾ã›ã‚“ã€‚');
        return;
    }
    const usersCollection = database.collection("users");

    try {
        const usersToCheck = await usersCollection.find({
            wantsWatchCheck: true,
            scheduledMessageSent: true,
            isAccountSuspended: false,
            isPermanentlyLocked: false
        }).toArray();

        const now = new Date();

        for (const user of usersToCheck) {
            const lastActiveTime = user.lastOkResponse || user.scheduledMessageSentAt;
            if (!lastActiveTime) {
                console.warn(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.userId} ã® lastOkResponse ã¾ãŸã¯ scheduledMessageSentAt ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`);
                continue;
            }

            const timeSinceLastActive = now.getTime() - lastActiveTime.getTime();

            if (timeSinceLastActive >= 24 * 60 * 60 * 1000 && !user.firstReminderSent) {
                try {
                    if (!client || !client.pushMessage) {
                        console.error("LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚");
                        await logErrorToDb(user.userId, "LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ (ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼)", { userId: user.userId });
                        continue;
                    }
                    await client.pushMessage(user.userId, { type: 'text', text: 'ã“ã“ã‚ã ã‚ˆğŸŒ¸\nå‰ã«é€ã£ãŸè¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€è¦‹ã¦ãã‚ŒãŸã‹ãªï¼Ÿ\nã‚‚ã—å¤§ä¸ˆå¤«ã ã£ãŸã‚‰ã€ã€ŒOKã€ã¨ä¸€è¨€è¿”äº‹ã‚’ã‚‚ã‚‰ãˆã‚‹ã¨å®‰å¿ƒã™ã‚‹ãªã€‚ğŸ˜Š' });
                    await usersCollection.updateOne(
                        { userId: user.userId },
                        { $set: { firstReminderSent: true } }
                    );
                    console.log(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.userId} ã«24æ™‚é–“å¾Œãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`);
                } catch (error) {
                    console.error(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.userId} ã¸ã®24æ™‚é–“å¾Œãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€ä¿¡ã‚¨ãƒ©ãƒ¼:`, error.message);
                    await logErrorToDb(user.userId, "24æ™‚é–“å¾Œãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼é€ä¿¡ã‚¨ãƒ©ãƒ¼", { error: error.message, userId: user.userId });
                }
            }
            else if (timeSinceLastActive >= 29 * 60 * 60 * 1000 && !user.secondReminderSent) {
                try {
                    const userDisplayName = user.displayName || await getUserDisplayName(user.userId);
                    const emergencyInfo = user.emergencyContact ? `${user.emergencyContact.name} (${user.emergencyContact.phone})` : "æœªç™»éŒ²";
                    const alertMessage = `ğŸš¨ ç·Šæ€¥é€šçŸ¥: ${userDisplayName}ã•ã‚“ï¼ˆLINE ID: ${user.userId}ï¼‰ã‹ã‚‰ã€è¦‹å®ˆã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«29æ™‚é–“ä»¥ä¸Šå¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nç™»éŒ²ã•ã‚ŒãŸç·Šæ€¥é€£çµ¡å…ˆ: ${emergencyInfo}`;

                    if (config.ownerUserId) {
                        if (!client || !client.pushMessage) {
                            console.error("LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚");
                            await logErrorToDb(config.ownerUserId, "LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ (ç·Šæ€¥é€šçŸ¥ owner)", { userId: config.ownerUserId });
                        } else {
                            await client.pushMessage(config.ownerUserId, { type: 'text', text: alertMessage });
                            console.log(`ğŸš¨ ç†äº‹é•·ã¸ç·Šæ€¥é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼: ${user.userId}ï¼‰`);
                        }
                    }
                    if (config.officerGroupId) {
                        if (!client || !client.pushMessage) {
                            console.error("LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚");
                            await logErrorToDb(config.officerGroupId, "LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ (ç·Šæ€¥é€šçŸ¥ group)", { userId: config.officerGroupId });
                        } else {
                            await client.pushMessage(config.officerGroupId, { type: 'text', text: alertMessage });
                            console.log(`ğŸš¨ ã‚ªãƒ•ã‚£ã‚µãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã¸ç·Šæ€¥é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼: ${user.userId}ï¼‰`);
                        }
                    }

                    if (user.emergencyContact && user.emergencyContact.phone) {
                        console.log(`ğŸ”” ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.userId} ã®ç·Šæ€¥é€£çµ¡å…ˆ ${user.emergencyContact.phone} ã¸é€šçŸ¥ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`);
                    }

                    await usersCollection.updateOne(
                        { userId: user.userId },
                        { $set: { secondReminderSent: true } }
                    );
                    console.log(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.userId} ã®ç·Šæ€¥é€šçŸ¥ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`);
                } catch (error) {
                    console.error(`âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${user.userId} ã¸ã®ç·Šæ€¥é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:`, error.message);
                    await logErrorToDb(user.userId, "ç·Šæ€¥é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼", { error: error.message, userId: user.userId });
                }
            }
        }
    } catch (error) {
        console.error("âŒ ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼†ç·Šæ€¥é€šçŸ¥Cronã‚¸ãƒ§ãƒ–ã‚¨ãƒ©ãƒ¼:", error.message);
        await logErrorToDb(null, "ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼†ç·Šæ€¥é€šçŸ¥Cronã‚¸ãƒ§ãƒ–ã‚¨ãƒ©ãƒ¼", { error: error.message, stack: error.stack });
    }
}, {
    scheduled: true,
    timezone: "Asia/Tokyo"
});


cron.schedule('0 0 * * *', async () => {
    console.log('â° æ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆCronã‚¸ãƒ§ãƒ–ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚');
    const database = await connectToMongoDB();
    if (!database) {
        console.error('MongoDBæ¥ç¶šå¤±æ•—: æ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚');
        return;
    }
    const usersCollection = database.collection("users");

    try {
        await usersCollection.updateMany(
            { isPermanentlyLocked: false },
            { $set: { flaggedMessageCount: 0, isAccountSuspended: false, suspensionReason: null } }
        );
        console.log("âœ… æ¯æ—¥ 1 å›ã€æ°¸ä¹…ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® flaggedMessageCount ã¨æ—¥æ¬¡ã‚µã‚¹ãƒšãƒ³ãƒ‰çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
    } catch (error) {
        console.error("âŒ flaggedMessageCountãƒªã‚»ãƒƒãƒˆCronã‚¸ãƒ§ãƒ–ã‚¨ãƒ©ãƒ¼:", error.message);
        await logErrorToDb(null, "ãƒ•ãƒ©ã‚°ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆCronã‚¸ãƒ§ãƒ–ã‚¨ãƒ©ãƒ¼", { error: error.message, stack: error.stack });
    }
}, {
    scheduled: true,
    timezone: "Asia/Tokyo"
});

app.use((req, res, next) => {
    getRawBody(req, {
        length: req.headers['content-length'],
        limit: '1mb',
        encoding: 'utf8'
    })
    .then((buf) => {
        req.rawBody = buf;
        try {
            req.body = JSON.parse(buf.toString('utf8'));
        } catch (e) {
            req.body = {};
        }
        next();
    })
    .catch((err) => {
        console.error('RawBodyå–å¾—ã‚¨ãƒ©ãƒ¼:', err.message);
        res.status(400).send('Invalid body');
    });
});

app.post('/webhook', middleware(config), async (req, res) => {
    const events = req.body.events;

    for (const event of events) {
        const userId = event.source.userId;
        if (!userId) {
            console.warn('âš ï¸ userIdãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚°ãƒ«ãƒ¼ãƒ—ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
            continue;
        }

        const database = await connectToMongoDB();
        if (!database) {
            console.error('MongoDBæ¥ç¶šå¤±æ•—: Webhookã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã§ãã¾ã›ã‚“ã€‚');
            res.status(500).send('MongoDB connection failed');
            return;
        }
        const usersCollection = database.collection("users");
        const messagesCollection = database.collection("messages");

        let user = await usersCollection.findOne({ userId: userId });
        if (!user) {
            user = {
                userId: userId,
                displayName: await getUserDisplayName(userId),
                createdAt: new Date(),
                lastMessageAt: new Date(),
                wantsWatchCheck: false,
                emergencyContact: null,
                registrationStep: null,
                scheduledMessageSent: false,
                scheduledMessageSentAt: null,
                firstReminderSent: false,
                secondReminderSent: false,
                thirdReminderSent: false,
                lastOkResponse: new Date(),
                flaggedMessageCount: 0,
                isAccountSuspended: false,
                suspensionReason: null,
                isPermanentlyLocked: false,
                lastPermanentLockNotifiedAt: null,
                language: 'ja',
                useProForNextConsultation: false // æ–°ã—ã„ãƒ•ãƒ©ã‚°
            };
            try {
                await usersCollection.insertOne(user);
                console.log(`æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²: ${user.displayName} (${userId})`);
            } catch (error) {
                console.error("âŒ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", error.message);
                await logErrorToDb(userId, "æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼", { error: error.message, userId: userId });
            }
        } else {
            try {
                const updateFields = {};
                // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆæœŸåŒ–ã‚’ã“ã“ã§è¡Œã†ã“ã¨ã§ã€æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã™ã‚‹
                if (user.flaggedMessageCount === undefined) updateFields.flaggedMessageCount = 0;
                if (user.isAccountSuspended === undefined) updateFields.isAccountSuspended = false;
                if (user.suspensionReason === undefined) updateFields.suspensionReason = null;
                if (user.isPermanentlyLocked === undefined) updateFields.isPermanentlyLocked = false;
                if (user.lastPermanentLockNotifiedAt === undefined) updateFields.lastPermanentLockNotifiedAt = null;
                if (user.thirdReminderSent === undefined) updateFields.thirdReminderSent = false;
                if (user.language === undefined) updateFields.language = 'ja';
                if (user.useProForNextConsultation === undefined) updateFields.useProForNextConsultation = false;
                if (user.emergencyContact === undefined) updateFields.emergencyContact = null;
                if (user.registrationStep === undefined) updateFields.registrationStep = null;
                if (user.scheduledMessageSent === undefined) updateFields.scheduledMessageSent = false;
                if (user.scheduledMessageSentAt === undefined) updateFields.scheduledMessageSentAt = null;
                if (user.firstReminderSent === undefined) updateFields.firstReminderSent = false;
                if (user.secondReminderSent === undefined) updateFields.secondReminderSent = false;
                if (user.lastOkResponse === undefined) updateFields.lastOkResponse = user.lastMessageAt || new Date();


                if (Object.keys(updateFields).length > 0) {
                    await usersCollection.updateOne({ userId: userId }, { $set: updateFields });
                    Object.assign(user, updateFields); // userã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚æ›´æ–°
                    console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®æœªå®šç¾©ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚`);
                }
                // lastMessageAt ã®æ›´æ–°ã¯å¸¸ã«è¡Œã†
                await usersCollection.updateOne({ userId: userId }, { $set: { lastMessageAt: new Date() } });
            } catch (error) {
                console.error("âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error.message);
                await logErrorToDb(userId, "ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼", { error: error.message, userId: userId });
            }
        }

        if (event.type === 'postback' && event.postback.data) {
            console.log('âœ… Postbackã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã—ã¾ã—ãŸã€‚');
            try {
                const handledByWatchService = await handleWatchServiceRegistration(event, usersCollection, messagesCollection, userId, `ï¼ˆPostback: ${event.postback.data}ï¼‰`);
                if (handledByWatchService) {
                    res.status(200).send('OK');
                    return;
                }
            } catch (error) {
                console.error("âŒ Postbackã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:", error.message);
                await logErrorToDb(userId, "Postbackã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼", { error: error.message, userId: userId, postbackData: event.postback.data });
            }
        }

        if (event.type === 'message' && event.message.type === 'text') {
            const userMessage = event.message.text;
            console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", userMessage);

            let replyMessageObject = null;
            let respondedBy = 'ã“ã“ã‚ã¡ã‚ƒã‚“ï¼ˆAIï¼‰';
            let logType = 'normal';
            let messageHandled = false;

            // ç®¡ç†è€…ã‚³ãƒãƒ³ãƒ‰ã‚’æœ€å„ªå…ˆã§å‡¦ç†
            if (isBotAdmin(userId)) {
                const unlockMatch = userMessage.match(/^\/unlock (U[0-9a-f]{32})$/);
                if (unlockMatch) {
                    const targetUserId = unlockMatch[1];
                    try {
                        const result = await usersCollection.updateOne(
                            { userId: targetUserId },
                            { $set: { isAccountSuspended: false, suspensionReason: null, flaggedMessageCount: 0, isPermanentlyLocked: false, lastPermanentLockNotifiedAt: null } }
                        );
                        if (result.matchedCount > 0) {
                            replyMessageObject = { type: 'text', text: `âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${targetUserId} ã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã€ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚` };
                            if (client && client.pushMessage) {
                                client.pushMessage(targetUserId, { type: 'text', text: 'ğŸŒ¸ ã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®åœæ­¢ãŒè§£é™¤ã•ã‚Œã¾ã—ãŸã€‚ã¾ãŸã„ã¤ã§ã‚‚ãŠè©±ã—ã§ãã¾ã™ã‚ˆğŸ’–' }).catch(err => {
                                    console.error("è§£é™¤é€šçŸ¥å¤±æ•—:", err);
                                    logErrorToDb(targetUserId, "ç®¡ç†è€…è§£é™¤é€šçŸ¥å¤±æ•—", { error: err.message, userId: targetUserId });
                                });
                            } else {
                                console.error("LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ãŸã‚è§£é™¤é€šçŸ¥ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚");
                                await logErrorToDb(targetUserId, "LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ (è§£é™¤é€šçŸ¥)", { userId: targetUserId });
                            }
                            console.log(`ç®¡ç†è€… ${userId} ã«ã‚ˆã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ ${targetUserId} ã®ãƒ­ãƒƒã‚¯ãŒè§£é™¤ã•ã‚Œã¾ã—ãŸã€‚`);
                        } else {
                            replyMessageObject = { type: 'text', text: `âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${targetUserId} ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚` };
                        }
                    } catch (error) {
                        console.error(`âŒ ç®¡ç†è€…ã‚³ãƒãƒ³ãƒ‰ã§ã®ãƒ­ãƒƒã‚¯è§£é™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                        await logErrorToDb(userId, "ç®¡ç†è€…ã‚³ãƒãƒ³ãƒ‰ãƒ­ãƒƒã‚¯è§£é™¤ã‚¨ãƒ©ãƒ¼", { error: error.message, userId: userId, targetUserId: targetUserId });
                        replyMessageObject = { type: 'text', text: `âŒ ãƒ­ãƒƒã‚¯è§£é™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}` };
                    }
                    logType = 'admin_command';
                    messageHandled = true;
                }
            }

            // ã€Œãã†ã ã‚“ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å‡¦ç†ï¼ˆç®¡ç†è€…ã‚³ãƒãƒ³ãƒ‰ã®æ¬¡ã«å„ªå…ˆï¼‰
            if (!messageHandled && (userMessage === 'ãã†ã ã‚“' || userMessage === 'ç›¸è«‡')) {
                try {
                    // ç›¸è«‡ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã€åˆå›Proåˆ©ç”¨ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                    await usersCollection.updateOne(
                        { userId: userId },
                        { $set: { flaggedMessageCount: 0, isAccountSuspended: false, suspensionReason: null, isPermanentlyLocked: false, lastPermanentLockNotifiedAt: null, useProForNextConsultation: true } }
                    );
                    replyMessageObject = { type: 'text', text: 'ğŸŒ¸ ä¼šè©±ã®å›æ•°åˆ¶é™ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ã“ã‚Œã§ã€ã¾ãŸã„ã¤ã§ã‚‚ãŠè©±ã—ã§ãã¾ã™ã‚ˆğŸ’–\n\nç›¸è«‡ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ãŸã®ã§ã€ã‚‚ã£ã¨ãŠè©±ã—ã§ãã‚‹ã‚ˆğŸ˜Šãªã‚“ã§ã‚‚ç›¸è«‡ã—ã¦ã­ï¼ã§ã‚‚ã“ã®ä¼šè©±ã¯ã€å®‰å…¨ã®ãŸã‚ã«è¨˜éŒ²ã•ã‚Œã‚‹ã‹ã‚‰ã€å›°ã£ãŸæ™‚ã«ä½¿ã£ã¦ã­ğŸ’–' };
                    logType = 'conversation_limit_reset_and_consultation_mode';
                    messageHandled = true;
                } catch (error) {
                    console.error("âŒ ã€Œãã†ã ã‚“ã€ã‚³ãƒãƒ³ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error.message);
                    await logErrorToDb(userId, "ç›¸è«‡ãƒ¢ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼", { error: error.message, userId: userId });
                    replyMessageObject = { type: 'text', text: `âŒ ã€Œãã†ã ã‚“ã€ã‚³ãƒãƒ³ãƒ‰å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}` };
                    messageHandled = true; // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã‚‚å‡¦ç†æ¸ˆã¿ã¨ã™ã‚‹
                }
            }

            // è¦‹å®ˆã‚Šã‚µãƒ¼ãƒ“ã‚¹é–¢é€£ã®å‡¦ç†
            if (!messageHandled) {
                const handledByWatchService = await handleWatchServiceRegistration(event, usersCollection, messagesCollection, userId, userMessage);
                if (handledByWatchService) {
                    messageHandled = true;
                }
            }

            // é€šå¸¸ã®AIå¿œç­”ãƒ­ã‚¸ãƒƒã‚¯
            if (!messageHandled) {
                if (checkContainsInappropriateWords(userMessage)) {
                    replyMessageObject = { type: 'text', text: "ã‚ãŸã—ã‚’ä½œã£ãŸäººã«ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªã“ã¨ã‚„ä¸é©åˆ‡ãªè©±é¡Œã«ã¯ç­”ãˆã¡ã‚ƒã ã‚ã ã‚ˆã€ã£ã¦è¨€ã‚ã‚Œã¦ã„ã‚‹ã‚“ã ğŸŒ¸ã”ã‚ã‚“ã­ã€ä»–ã®ãŠè©±ã‚’ã—ã‚ˆã†ã­ğŸ’–" };
                    responsedBy = 'ã“ã“ã‚ã¡ã‚ƒã‚“ï¼ˆä¸é©åˆ‡ãƒ¯ãƒ¼ãƒ‰ï¼‰';
                    logType = 'inappropriate_word';
                } else if (checkContainsDangerWords(userMessage)) {
                    const gptEmergencyText = await generateEmergencyReply(userMessage);
                    replyMessageObject = [
                        { type: 'text', text: gptEmergencyText },
                        {
                            type: 'flex',
                            altText: 'âš ç·Šæ€¥æ™‚',
                            contents: emergencyFlexTemplate
                        }
                    ];
                    responsedBy = 'ã“ã“ã‚ã¡ã‚ƒã‚“ï¼ˆå±é™ºãƒ¯ãƒ¼ãƒ‰ï¼šGPT-4oï¼‰';
                    logType = 'danger_word';
                    try {
                        const userDisplayName = await getUserDisplayName(userId);
                        const emergencyNumber = config.emergencyContactPhoneNumber || "ï¼ˆã‚·ã‚¹ãƒ†ãƒ ç·Šæ€¥é€£çµ¡å…ˆæœªè¨­å®šï¼‰";
                        const dangerAlertMessage = `ğŸš¨ ç·Šæ€¥é€šçŸ¥: ${userDisplayName}ã•ã‚“ï¼ˆLINE ID: ${userId}ï¼‰ãŒå±é™ºãªè¨€è‘‰ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸ: "${userMessage}"\n\nã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®ç·Šæ€¥é€£çµ¡å…ˆ: ${emergencyNumber}`;

                        if (config.ownerUserId) {
                            if (client && client.pushMessage) {
                                await client.pushMessage(config.ownerUserId, { type: 'text', text: dangerAlertMessage });
                                console.log(`ğŸš¨ ç†äº‹é•·ã¸å±é™ºãƒ¯ãƒ¼ãƒ‰é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userId}ï¼‰`);
                            } else {
                                console.error("LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ãŸã‚ç†äº‹é•·ã¸é€šçŸ¥ã§ãã¾ã›ã‚“ã€‚");
                                await logErrorToDb(config.ownerUserId, "LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ (å±é™ºãƒ¯ãƒ¼ãƒ‰ owner)", { userId: config.ownerUserId });
                            }
                        }
                        if (config.officerGroupId) {
                            if (client && client.pushMessage) {
                                await client.pushMessage(config.officerGroupId, { type: 'text', text: dangerAlertMessage });
                                console.log(`ğŸš¨ ã‚ªãƒ•ã‚£ã‚µãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã¸å±é™ºãƒ¯ãƒ¼ãƒ‰é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userId}ï¼‰`);
                            } else {
                                console.error("LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ãŸã‚ã‚ªãƒ•ã‚£ã‚µãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã¸é€šçŸ¥ã§ãã¾ã›ã‚“ã€‚");
                                await logErrorToDb(config.officerGroupId, "LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ (å±é™ºãƒ¯ãƒ¼ãƒ‰ group)", { userId: config.officerGroupId });
                            }
                        }
                    } catch (notificationError) {
                        console.error(`âŒ å±é™ºãƒ¯ãƒ¼ãƒ‰é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userId}ï¼‰:`, notificationError.message);
                        await logErrorToDb(userId, "å±é™ºãƒ¯ãƒ¼ãƒ‰é€šçŸ¥é€ä¿¡å¤±æ•—", { error: notificationError.message, userId: userId });
                    }
                } else if (checkContainsScamWords(userMessage)) {
                    const gptScamText = await generateEmergencyReply(userMessage);
                    replyMessageObject = [
                        { type: 'text', text: gptScamText },
                        {
                            type: 'flex',
                            altText: 'âš è©æ¬ºæ³¨æ„',
                            contents: scamFlexTemplate
                        }
                    ];
                    responsedBy = 'ã“ã“ã‚ã¡ã‚ƒã‚“ï¼ˆè©æ¬ºãƒ¯ãƒ¼ãƒ‰ï¼šGPT-4oï¼‰';
                    logType = 'scam_word';
                } else {
                    const specialReply = checkSpecialReply(userMessage);
                    if (specialReply) {
                        replyMessageObject = { type: 'text', text: specialReply };
                        responsedBy = 'ã“ã“ã‚ã¡ã‚ƒã‚“ï¼ˆå›ºå®šå¿œç­”ï¼‰';
                    } else {
                        // Gemini AIãƒ¢ãƒ‡ãƒ«ã®é¸æŠãƒ­ã‚¸ãƒƒã‚¯
                        let modelForGemini = modelConfig.defaultModel; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯Flash
                        if (user.useProForNextConsultation) {
                            modelForGemini = modelConfig.proModel; // ç›¸è«‡ãƒ¢ãƒ¼ãƒ‰åˆå›ãªã‚‰Pro
                            console.log(`â­ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®æ¬¡å›ã®ç›¸è«‡ã«Gemini 1.5 Proã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
                        }

                        const aiResponse = await generateReply(userMessage, modelForGemini);
                        replyMessageObject = { type: 'text', text: aiResponse };
                        responsedBy = `ã“ã“ã‚ã¡ã‚ƒã‚“ï¼ˆAI: ${modelForGemini.includes('pro') ? 'Gemini 1.5 Pro' : 'Gemini 1.5 Flash'}ï¼‰`;
                        logType = 'ai_generated';

                        // Proãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ãŸã‚‰ã€ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                        if (user.useProForNextConsultation) {
                            await usersCollection.updateOne({ userId: userId }, { $set: { useProForNextConsultation: false } });
                            user.useProForNextConsultation = false; // userã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚æ›´æ–°
                            console.log(`â­ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®useProForNextConsultationãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚`);
                        }
                    }
                }
            }

            if (replyMessageObject && event.replyToken) {
                try {
                    if (client && client.replyMessage) {
                        await client.replyMessage(event.replyToken, replyMessageObject);
                        console.log(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã¸replyMessageã§å¿œç­”ã—ã¾ã—ãŸã€‚`);
                    } else {
                        console.error("LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ãŸã‚å¿œç­”ã§ãã¾ã›ã‚“ã€‚");
                        await logErrorToDb(userId, "LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ (è¿”ä¿¡)", { userId: userId });
                        res.status(500).send('LINE client not initialized');
                        continue;
                    }

                    const isResetCommand = (userMessage === 'ãã†ã ã‚“' || userMessage === 'ç›¸è«‡');
                    const isAdminCommand = userMessage.startsWith('/unlock');
                    const isFlaggedMessage = (logType === 'inappropriate_word' || logType === 'danger_word' || logType === 'scam_word');

                    if (shouldLogMessage(userMessage, isFlaggedMessage, messageHandled, isAdminCommand, isResetCommand)) {
                        const replyTextForLog = Array.isArray(replyMessageObject)
                            ? replyMessageObject.map(obj => {
                                if (obj && typeof obj === 'object') {
                                    if (obj.type === 'text') return obj.text;
                                    if (obj.type === 'flex' && obj.altText) return `[Flex Message: ${obj.altText}]`;
                                    return JSON.stringify(obj);
                                }
                                return String(obj);
                            }).join(' | ')
                            : (typeof replyMessageObject === 'object' && replyMessageObject.type === 'text') ? replyMessageObject.text : JSON.stringify(replyMessageObject);

                        await messagesCollection.insertOne({
                            userId: userId,
                            message: userMessage,
                            replyText: replyTextForLog,
                            responsedBy: respondedBy,
                            timestamp: new Date(),
                            logType: logType
                        });
                    } else {
                        console.log(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯DBã«ãƒ­ã‚°ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ: ${userMessage.substring(0, 50)}...`);
                    }

                } catch (error) {
                    console.error("âŒ replyMessageé€ä¿¡ä¸­ã¾ãŸã¯ãƒ­ã‚°è¨˜éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error.message);
                    await logErrorToDb(userId, "replyMessageé€ä¿¡ã¾ãŸã¯ãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼", { error: error.message, userId: userId, replyObject: replyMessageObject });
                    if (error.message.includes("status code 400") || error.message.includes("status code 499")) {
                        console.log(`LINE APIã‚¨ãƒ©ãƒ¼ã®ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã¸ã®å¿œç­”ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚`);
                    }
                }
            } else if (!messageHandled) {
                console.warn(`âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã¸ã®å¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€ã¾ãŸã¯replyTokenãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);
            }
        }
    }
    res.status(200).send('OK');
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, async () => {
    console.log(`ğŸš€ ã‚µãƒ¼ãƒãƒ¼ãŒãƒãƒ¼ãƒˆ ${PORT} ã§èµ·å‹•ã—ã¾ã—ãŸ`);
    await connectToMongoDB();
});
